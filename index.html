<!-- This code uses much of the code from molSimplify Lite. There are additional buttons for solvent removal and thermal stability predictions, and many MOF centered operations (visualization, component identification, etc). An example MOF is prepared by default, using fetch. 
In a terminal, navigate to folder containing app.py.
Then, to open the website, run python app.py in the terminal. Copy and paste http://0.0.0.0:8000/ into the search browser URL bar.
-->


<!-- Import NGL, webGavrog, and Bootstrap libraries-->
<script src="libraries/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="libraries/ngl.js"></script>
<script type="text/javascript" src="libraries/webGavrog/runtime.js"></script>
<script type="text/javascript" src="libraries/webGavrog/vendors.js"></script>
<script type="text/javascript" src="libraries/webGavrog/main.js"></script>
<script src="libraries/3Dmol-min.js"></script>
<script src="libraries/bootstrap.min.js"></script>
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-2.3.1.min.js"></script>

<!-- Import CSS -->
<link rel="stylesheet" href="libraries/bootstrap.min.css">
<link rel="stylesheet" href="libraries/bootstrap_custom.min.css">

<!-- Imports related to star rating -->
<link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.0/css/star-rating.min.css" media="all"
rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.0/js/star-rating.min.js"
type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.0/themes/krajee-svg/theme.css" media="all"
rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.0/themes/krajee-svg/theme.js"></script>

<!-- Custom CSS code is placed within the <style> tag: -->
  <style>
    .btn {
      margin-top: 3px;
    }

    .mol-container {
      /* For component visualization */
      height: 400px;
      position: relative;
    }

    .form-control {
      margin-bottom: 0.1cm;
    }

    .round_button {
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      min-width: 130px;
    }

    .selection_button {
      display: inline-block;
      width: 33%;
    }

    .link {
      /* hyperlinks are blue */
      color: #279AF1;
    }

    #viewportwrapper {
      /* For MOF visualization */
      grid-area: viz;
    }  

    #chart {
      /* thermal breakdown plot is centered, when thermal stability prediction is made */
      width: 100%;
      text-align: center;
    }

    #header_background {
      background-image: url('banner_light');
      background-position: center; /* Keeps the banner centered even when window is shrunken */
      background-size: cover; /* Makes the banner the appropriate size */
    }

    body {
      /* The font to be used everywhere */
      font-family: Arial, Helvetica, sans-serif;
      color: black;
      font-size: 16px;
    }

    .perm {
      background: none;
      border: none;
    }

    .pill-custom {
      border-radius: 0px 0px 0px 0px !important;
      border: 0px;
      color: black !important;
      background-color: white !important;
      padding-left: 0px;
      padding-right: 0px;
    }

    .pill-custom.active {
      background-color: #f7f7f7 !important;
      border-bottom: 5px solid black !important;
    }

    .pill-custom:hover {
      color: #18bc9c !important;
    }
  </style>


  <head>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7B1L0P0FXV"></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7B1L0P0FXV');
    </script>
    <!--   End of Google Analytics stuff -->

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 

    <title>MOFSimplify</title>

  </head>


  <body>
    <!-- The following code creates a navbar. Each navbar item is in a list entry of class "nav-item". -->
    <div class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
      <div class="container">
        <a href="../" class="navbar-brand" style='font-size: 30px;'>MOFSimplify</a>
        <button class="navbar-toggler" type='button' data-toggle="collapse" data-target="#navbarResponsive"
        aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"><!-- Toggle navbar --></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive" style='font-size: 20px;'>
        <ul class="navbar-nav">
            <li class="nav-item" style='padding-left: 30px;'>
              <a class="nav-link" href="stable_MOFs.html">Stable MOFs</a>
            </li>            
            <li class="nav-item" style='padding-left: 30px;'>
              <a class="nav-link" href="how_to_cite.html">How to Cite</a>
            </li>
            <li class="nav-item" style='padding-left: 30px;'>
              <a class="nav-link" href="https://github.com/hjkgrp/MOFSimplify">Source Code</a>
            </li>
            <li class="nav-item" style='padding-left: 30px;'>
              <a class="nav-link" href="https://github.com/hjkgrp/molSimplify/tree/master/molSimplify/Informatics/MOF">MOF Code</a>
            </li>
          </ul>

        </div>
        <button class='btn btn-primary round_button' id='dark_mode' type='button' style='font-size:22px; width:20%;'>Dark mode</button>
      </div>
    </div>

    <div class="container">
      <div class="page-header" id="banner">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12" id='header_background'>
            <!-- Title -->
            <span style='position:relative;'>
              <!-- The zebra class changes color depending if Dark mode is toggled on or not. -->
              <p style="font-size: 27px; width:100%; text-align:center; font-style: italic; color: #2B3E50; margin-top: 6cm;"
              class='zebra'>The <a class="link" href="http://hjkgrp.mit.edu/">Kulik Group</a> at MIT <br> Powered by <a
              class="link" href="https://molsimplify.readthedocs.io/en/latest/">molSimplify</a></p>
            </span>
          </div>
        </div>
      </div>


      <!-- The 4 tabs of the website -->
      <ul class="nav nav-pills mb-3" id="pills-tab"
      style="overflow-x: auto;text-align: center;margin-left:-15px;margin-right:-15px;margin-bottom: 10px;border-bottom-width: 1px;border-bottom-style: solid; border-bottom-color:#d6d9dc; flex-wrap:nowrap;">
      <li class="nav-item" role="presentation" style='width:25%; min-width:150px;'>
        <button class="nav-link pill-custom active" id="pills-main-tab"
        style='width:100%; height:100%; font-weight: bold; font-size:24px;'>Main</button>
      </li>
      <li class="nav-item" role="presentation" style='width:25%; min-width:150px;'>
        <button class="nav-link pill-custom" id="pills-vis-tab"
        style='width:100%; height: 100%; font-weight: bold; font-size:24px;'>Visualization</button>
      </li>
      <li class="nav-item" role="presentation" style='width:25%; min-width:150px;'>
        <button class="nav-link pill-custom" id="pills-comp-tab"
        style='width:100%; height: 100%; font-weight: bold; font-size:24px;'>Component Analysis</button>
      </li>
      <li class="nav-item" role="presentation" style='width:25%; min-width:150px;'>
        <button class="nav-link pill-custom" id="pills-data-tab"
        style='width:100%; height: 100%; font-weight: bold; font-size:24px;'>Data Upload</button>
      </li>
    </ul>

    <!-- The Main tab of the website -->
    <div id="pills-main" class="container"> 
      <b style='font-size:22px;' class='zebra'> 1) Select a MOF (metal-organic framework) for analysis</b>
      <!-- Create a section containing buttons -->
      <div class='col-lg-12'>
        <div style='width:100%; text-align:center; margin-top:0.25cm;'>
          <!-- Button for queuing up the example MOF cif file -->
          <button class='btn btn-primary round_button selection_button' id='example-redirect' type='button'
          style='font-size:22px;'>Example MOF</button>
          <!-- Button for uploading MOF cif file -->
          <button class='btn btn-primary round_button selection_button' id='upload' type='button'
          style='font-size:22px;'>Custom (upload cif file)</button>
          <!-- Button for uploading MOF cif file -->
          <button class='btn btn-primary round_button selection_button' id='bb-redirect' type='button'
          style='font-size:22px;'>Building block assembly</button>
          <p class='zebra' id='cif_hint' style='display:inline-block; width:100%; font-size: 22px; margin-bottom: 0.25cm;'>Uploaded cif file must be disorder free and without floating solvent</p>
          <p class='zebra' style='font-size:22px;' id='permission_line'>May MOFSimplify store information on your MOFs? &nbsp&nbsp<button style='color: green;' id='perm_yes' class='perm'>Yes.</button>&nbsp&nbsp&nbsp<button style='color: red;' id='perm_no' class='perm'>No.</button></p> <!-- &nbsp is a space gap -->
        </div>
      </div>

      <div id='predict_section' style='margin-top: 1cm;'>
        <b style='font-size:22px;' class='zebra'> 2) Predict properties of the selected MOF </b>
        <!-- Create a section containing buttons -->
        <div class='col-lg-12'>
          <div style='width:100%; text-align:center; margin-top:0.25cm;'>
            <!-- Button for predicting solvent removal stability of MOF -->
            <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
            id='predict_s' type='button'>Stability upon solvent removal</button>
            <!-- Button for predicting thermal stability of MOF -->
            <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
            id='predict_t' type='button'>Thermal stability</button>
          </div>
        </div>

      </div>

      <div id='descriptor_section' style='margin-top: 1cm;'>
        <b style='font-size:22px;' class='zebra'> 3) Download descriptors of the selected MOF </b>
        <!-- Create a section containing buttons -->
        <div class='col-lg-12'>
          <div style='width:100%; text-align:center; margin-top:0.25cm;'>
            <!-- Button for downloading descriptors of MOF -->
            <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
            id='download_descriptors' type='button'>Download descriptors</button>
          </div>
        </div>
      </div>

      <!-- Section where the MOF predictions are placed once predictions are made. Also displays which MOF is currently queued up and ready for analysis. -->
      <div id='status_section' class='row'
      style='margin-top: 1cm;border-left:5px solid gray;border-color:#2c3e50;padding-left:5px;background-color:#f7f7f7;'>
      <b style='font-size:22px;'> Status messages and MOF predictions </b>
      <div class='col-12' style='font-size:22px;' id='upload_status'></div>
      <div class='col-12' style='font-size:22px;' id='solvent_stability_prediction'>
      </div>
      <div class='col-12' id='solvent_form'>
        <form class='col-10' style='font-size:22px;margin-left:15px' id='solvent_stability_feedback' action='/process_feedback' method="POST" enctype="multipart/form-data">
          <input type="hidden" name="feedback_form_name" value="solvent_stability" />
          <input type="hidden" name="cif_file_name" value="" />
          <input type="hidden" name="structure" value="" />
          <i id='rate_solvent'>Rate this prediction: *</i> 
          <input name="rating" id="solvent_rating" type="text" class="rating" data-size="md" required>
          <div style="" class="input-group mt-2">
            <div class="input-group-prepend">
              <span class="input-group-text" id="solvent_rating_email_desc">Email (.edu preferred) *</span>
            </div>
            <input name="email" type="email" id="solvent_rating_email" aria-describedby="solvent_rating_email_desc"
            class="form-control" required>
          </div>
          <select name="reason" id="inputState_A" class="form-control mt-2 mb-0" required>
            <option value="">Reason for rating... *</option>
            <option>I've worked with this MOF before, the prediction is good</option>
            <option>I've worked with this MOF before, the prediction is bad (please upload data)</option>
            <option>The literature contains counter examples of this prediction (provide DOI of papers with counterexamples in comment field)</option>
            <option>The paper is incorrect (provide reasoning in comment field)</option>
            <option>The label obtained from the paper is incorrect (provide reasoning in comment field)</option>
          </select>
          <div class="input-group mt-2" style="">
            <div class="input-group-prepend">
              <span class="input-group-text" id="solvent_rating_comments_desc">Comments</span>
            </div>
            <input name="comments" type="text" id="solvent_rating_comments" aria-describedby="solvent_rating_comments_desc"
            class="form-control">
          </div>
          <div class="custom-file form-control mt-2">
            <input name="file" type="file" class="custom-file-input" id="validatedCustomFile_A">
            <label class="custom-file-label" for="validatedCustomFile_A" id="TGA_A">Upload TGA Trace (.pdf, .jpg, .png,
            .tiff; 20 MB max)</label>
            <div class="invalid-feedback">Example invalid custom file feedback</div>
          </div>
          <div class="input-group mt-2" style="">
            <div class="input-group-prepend">
              <span class="input-group-text" id="solvent_rating_solvname_desc">Solvent evacuated for selected MOF</span>
            </div>
            <input name="solvent" type="text" id="solvent_rating_solvname" aria-describedby="solvent_rating_solvname_desc"
            class="form-control">
          </div>
          <button type="submit" class="btn btn-primary mt-2" id="submit_A">Submit</button>
        </form>
      </div>

      <div class='col-12' style='font-size:22px;' id='thermal_stability_prediction'></div>
      <div class='col-12' style='font-size:22px;' id='thermal_stability_percentile'></div>
      <div class="col-12" id="thermal_form">
        <form class='col-10' style='font-size:22px;margin-left:15px' id='thermal_stability_feedback' action='/process_feedback' method="POST" enctype="multipart/form-data">
          <input type="hidden" name="feedback_form_name" value="thermal_stability" />
          <input type="hidden" name="cif_file_name" value="" />
          <input type="hidden" name="structure" value="" />
          <i id='rate_thermal'>Rate this prediction: *</i>
          <input name="rating" id="thermal_rating" type="text" class="rating" data-size="md" required>
          <div style="" class="input-group mt-2">
            <div class="input-group-prepend">
              <span class="input-group-text" id="thermal_rating_email_desc">Email (.edu preferred) *</span>
            </div>
            <input name="email" type="email" id="thermal_rating_email" aria-describedby="thermal_rating_email_desc"
            class="form-control" required>
          </div>
          <select name="reason" id="inputState_B" class="form-control mt-2 mb-0" required>
            <option value="">Reason for rating... *</option>
            <option>I've worked with this MOF before, the prediction is good</option>
            <option>I've worked with this MOF before, the prediction is bad (please upload data)</option>
            <option>The literature contains counter examples of this prediction (provide DOI of papers with counterexamples in comment field)</option>
            <option>The paper is incorrect (provide reasoning in comment field)</option>
            <option>The label obtained from the paper is incorrect (provide reasoning in comment field)</option>
          </select>
          <div class="input-group mt-2" style="">
            <div class="input-group-prepend">
              <span class="input-group-text" id="thermal_rating_comments_desc">Comments</span>
            </div>
            <input name="comments" type="text" id="thermal_rating_comments" aria-describedby="thermal_rating_comments_desc"
            class="form-control">
          </div>
          <div class="custom-file form-control mt-2">
            <input name="file" type="file" class="custom-file-input" id="validatedCustomFile_B">
            <label class="custom-file-label" for="validatedCustomFile_B" id="TGA_B">Upload TGA Trace (.pdf, .jpg, .png,
            .tiff; 20 MB max)</label>
            <div class="invalid-feedback">Example invalid custom file feedback</div>
          </div>
          <div class="input-group mt-2" style="">
            <div class="input-group-prepend">
              <span class="input-group-text" id="thermal_rating_solvname_desc">Solvent evacuated for selected MOF</span>
            </div>
            <input name="solvent" type="text" id="thermal_rating_solvname" aria-describedby="thermal_rating_solvname_desc"
            class="form-control">
          </div>
          <button type="submit" class="btn btn-primary mt-2" id="submit_B">Submit</button>
        </form>
      </div>
      <div class='col-12' style='font-size:22px;' id='chart'></div>
    </div>

    <div class='row' id='neighbor_blurb'>
      <p class='col-12 zebra' style='margin-top: 0.5cm; font-size:22px;'> Nearest neighbors come from the pool of
        training data (i.e. <a class='link' href='https://zenodo.org/record/3370144#.YQBeCC1h2L2'>CoRE MOFs</a>) used
        to
      train an ANN.</p>
    </div>

    <div class='row'>

      <div class='col-6 zebra' style='font-size:22px;' id='solvent_neighbor_section'>
        Solvent removal stability ANN nearest neighbors <br> in latent space
        <select class='form-control' id='solvent_neighbors' style='font-size:22px;'>
        </select>

        <div style='width:100%; text-align:center; margin-top:0.5cm;'>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='s_neighbor' type='button'>Show</button>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='download_s_neighbor' type='button'>Download</button>
        </div>
        <div style='width:100%; text-align:center;'>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='visualize_s_neighbor' type='button'>Visualize</button>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='comp_s_neighbor' type='button'>Get components</button>
        </div>
        <p id='s_neighbor_info' style='font-size:20px;' class='zebra'></p>
        <!-- Feedback form for solvent neighbor -->
        <div id="solvent_neighbor_form">
          <form class='col-10' style='font-size:22px;margin-left:15px' id='solvent_stability_neighbor_feedback' action='/process_feedback' method="POST" enctype="multipart/form-data">
            <input type="hidden" name="feedback_form_name" value="solvent_stability_neighbor" />
            <input type="hidden" name="cif_file_name" value="" />
            <input type="hidden" name="structure" value="" />
            <i>Rate this existing data: *</i>
            <input name="rating" id="solvent_neighbor_rating" type="text" class="rating" data-size="md" required>
            <div style="" class="input-group mt-2">
              <div class="input-group-prepend">
                <span class="input-group-text" id="solvent_neighbor_rating_email_desc">Email (.edu preferred) *</span>
              </div>
              <input name="email" type="email" id="solvent_neighbor_rating_email" aria-describedby="solvent_neighbor_rating_email_desc"
              class="form-control" required>
            </div>
            <select name="reason" id="inputState_C" class="form-control mt-2 mb-0" required>
              <option value="">Reason for rating... * </option>
              <option>I've worked with this MOF before, the deposited data is good</option>
              <option>I've worked with this MOF before, the deposited data is bad (please upload data)</option>
              <option>The literature contains counter examples of this deposited data (provide DOI of papers with counterexamples in comment field)</option>
              <option>The paper is incorrect (provide reasoning in comment field)</option>
              <option>The label obtained from the paper is incorrect (provide reasoning in comment field)</option>
            </select>
            <div class="input-group mt-2" style="">
              <div class="input-group-prepend">
                <span class="input-group-text" id="solvent_neighbor_rating_comments_desc">Comments</span>
              </div>
              <input name="comments" type="text" id="solvent_neighbor_rating_comments" aria-describedby="solvent_neighbor_rating_comments_desc"
              class="form-control">
            </div>
            <div class="custom-file form-control mt-2">
              <input name="file" type="file" class="custom-file-input" id="validatedCustomFile_C">
              <label class="custom-file-label" for="validatedCustomFile_C" id="TGA_C">Upload File (optional; .pdf, .jpg, .png, .tiff; 20 MB max)</label>
              <div class="invalid-feedback">Example invalid custom file feedback</div>
            </div>
            <div class="input-group mt-2" style="">
              <div class="input-group-prepend">
                <span class="input-group-text" id="solvent_neighbor_rating_solvname_desc">Solvent evacuated for selected MOF</span>
              </div>
              <input name="solvent" type="text" id="solvent_neighbor_rating_solvname" aria-describedby="solvent_neighbor_rating_solvname_desc"
              class="form-control">
            </div>
            <button type="submit" class="btn btn-primary mt-2" id="submit_C">Submit</button>
          </form>
        </div>
      </div>

      <div class='col-6 zebra' style='font-size:22px;' id='thermal_neighbor_section'>
        Thermal stability ANN nearest neighbors <br> in latent space
        <select class='form-control' id='thermal_neighbors' style='font-size:22px;'>
        </select>

        <div style='width:100%; text-align:center; margin-top:0.5cm;'>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='t_neighbor' type='button'>Show</button>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='download_t_neighbor' type='button'>Download</button>
        </div>
        <div style='width:100%; text-align:center;'>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='visualize_t_neighbor' type='button'>Visualize</button>
          <button style='display:inline-block; width:49%; font-size:22px;' class='btn btn-primary round_button'
          id='comp_t_neighbor' type='button'>Get components</button>
        </div>
        <p id='t_neighbor_info' style='font-size:20px;' class='zebra'></p>
        <div id="thermal_neighbor_form">
          <form class='col-10' style='font-size:22px;margin-left:15px' id='thermal_stability_neighbor_feedback' action='/process_feedback' method="POST" enctype="multipart/form-data">
            <input type="hidden" name="feedback_form_name" value="thermal_stability_neighbor" />
            <input type="hidden" name="cif_file_name" value="" />
            <input type="hidden" name="structure" value="" />
            <i>Rate this existing data: *</i>
            <input name="rating" id="thermal_neighbor_rating" type="text" class="rating" data-size="md" required>
            <div style="" class="input-group mt-2">
              <div class="input-group-prepend">
                <span class="input-group-text" id="thermal_neighbor_rating_email_desc">Email (.edu preferred) *</span>
              </div>
              <input name="email" type="email" id="thermal_neighbor_rating_email" aria-describedby="thermal_neighbor_rating_email_desc"
              class="form-control" required>
            </div>
            <select name="reason" id="inputState_D" class="form-control mt-2 mb-0" required>
              <option value="">Reason for rating... *</option>
              <option>I've worked with this MOF before, the deposited data is good</option>
              <option>I've worked with this MOF before, the deposited data is bad (please upload data)</option>
              <option>The literature contains counter examples of this deposited data (provide DOI of papers with counterexamples in comment field)</option>
              <option>The paper is incorrect (provide reasoning in comment field)</option>
              <option>The label obtained from the paper is incorrect (provide reasoning in comment field)</option>
            </select>
            <div class="input-group mt-2" style="">
              <div class="input-group-prepend">
                <span class="input-group-text" id="thermal_neighbor_rating_comments_desc">Comments</span>
              </div>
              <input name="comments" type="text" id="thermal_neighbor_rating_comments" aria-describedby="thermal_neighbor_rating_comments_desc"
              class="form-control">
            </div>
            <div class="custom-file form-control mt-2">
              <input name="file" type="file" class="custom-file-input" id="validatedCustomFile_D">
              <label class="custom-file-label" for="validatedCustomFile_D" id="TGA_D">Upload File (optional; .pdf, .jpg, .png, .tiff; 20 MB max)</label>
              <div class="invalid-feedback">Example invalid custom file feedback</div>
            </div>
            <div class="input-group mt-2" style="">
              <div class="input-group-prepend">
                <span class="input-group-text" id="thermal_neighbor_rating_solvname_desc">Solvent evacuated for selected MOF</span>
              </div>
              <input name="solvent" type="text" id="thermal_neighbor_rating_solvname" aria-describedby="thermal_neighbor_rating_solvname_desc"
              class="form-control">
            </div>
            <button type="submit" class="btn btn-primary mt-2" id="submit_D">Submit</button>
          </form>
        </div>
        <div class='col-6' id='tga_plot'></div>

        <div id='tga_explanation' style='display: none; margin-top: 0.5cm;' class='zebra'>
          <img src='TGA_graphic.png' alt='Explanatory graphic for simplified TGA plots' style='max-width: 120%;'>
          <p> In order to generate the simplified TGA plot, four points on the experimental TGA plot are chosen. These
            points represent two lines of different slope on the TGA plot. The two lines are extrapolated until they
          intersect, and the point of intersection is taken to be the breakdown temperature.</p>
        </div>
      </div>
    </div>
  </div>


  <!-- The Visualization tab of the website -->
  <div id="pills-vis">
    <!-- MOF viewer and buttons -->

    <div id="viewportwrapper" style="border-style: solid;border-width:2px;" class="content inactive">
      <!-- MOF visualization -->
      <div id="viewportnote" style="position: relative; top: 9em; text-align: center; z-index: 2; font-size: 28px;">
        MOF
        unit cells are visualized here. <br> Left click to rotate, right click with mouse to move, scroll with mouse
        to
      zoom.</div>
      <div id="cifviewport" style="width=100%; height:500px;">
      </div>
    </div>
    <div style="margin-bottom:0.5cm;"></div>
    <div style='width:100%; text-align:center;'>
      <button class='btn btn-primary round_button' style='display:inline-block; width:50%; font-size: 22px'
      id='visualize' type='button'>Visualize selected (1) MOF</button>
      <p class='zebra' style='display:inline-block; width:100%; font-size: 22px'> Special thanks to the Koes and Snurr
      groups for developing visualization code. </p>
    </div>

    <div style='width:100%; text-align:center;'>
      <div style='display:inline-block; font-size: 22px;' id='currently_visualized' class='zebra'></div>
    </div>
    <div style='width:100%; text-align:center;'>
      <div style='display:inline-block; font-size: 22px;' id='status_visualization'></div>
    </div>
  </div>

  <!-- The Component Analysis tab of the website -->
  <div id="pills-comp">
    <div class='row'>
      <div class='col-lg-6' style='margin-top: 0.5cm;'>
        <div id='container-01' class='mol-container'
        style='border-style:solid;border-width:2px;background-color: white;'>
        <div id='container-01-note'
        style='position: relative; top: 7em; text-align: center; z-index: 2; font-size: 22px;'>MOF linkers and
        SBUs
        are visualized here. <br> Left click to rotate, scroll with mouse to zoom.</div>
      </div>
      <div style="margin-bottom:0.5cm;"></div>
      <div style='width:100%; text-align:center;'>
        <button style='display:inline-block; width:32%; font-size: 22px;' class='btn btn-primary round_button'
        id='visualize_linker' type='button'>Linker</button>
        <button style='display:inline-block; width:32%; font-size: 22px;' class='btn btn-primary round_button'
        id='visualize_sbu' type='button'>SBU</button>
        <button style='display:inline-block; width:32%; font-size: 22px;' class='btn btn-primary round_button'
        id='reset_zoom' type='button'>Reset zoom</button>
        <button style='display:inline-block; width:49%; font-size: 22px;' class='btn btn-primary round_button'
        id='download_linker' type='button'>Download linker</button>
        <button style='display:inline-block; width:49%; font-size: 22px;' class='btn btn-primary round_button'
        id='download_sbu' type='button'>Download SBU</button>
      </div>
    </div>

    <div class='col-lg-6' style='margin-top: 0.5cm;'>
      <!-- Button for getting MOF components for visualization  -->
      <div style='width:100%; text-align:center;'>
        <button style='display:inline-block; width:80%; font-size: 22px; margin-bottom: 0.5cm;'
        class='btn btn-primary round_button' id='get_components' type='button'>Get selected (1) MOF
      components</button>
    </div>

    <div id='comp_MOF' style='font-size: 22px;' class='zebra'> </div> <!-- Will display information on what MOF's components are currently visualized -->

    <div style='font-size: 22px; margin-top: 0.5cm' class='zebra'>
      Linkers
      <select style='font-size: 22px;' class='form-control' id='linker'>
      </select>
    </div>

    <div style='font-size: 22px;' class='zebra'>
      SBUs
      <select style='font-size: 22px;' class='form-control' id='sbu'> </select>
    </div>

    <div style='width:100%; text-align:center; margin-top:0.5cm;'>
      <button style='display:inline-block; width:80%; margin-bottom: 0.5cm; font-size: 22px;'
      class='btn btn-primary round_button' id='toggle_unique_components' type='button'>Filter by
    connectivity</button>
  </div>

  <div class='col-12 zebra'>
    <p id='component_SMILES'
    style='margin-top:0.5cm; margin: auto; width:100%; text-align: center; font-size: 22px;'> </p>
    <p id='resize_hint'
    style='display: none; margin-top:0.5cm; margin: auto; width:100%; text-align: center; font-style:italic; font-size: 20px;'>
  Component not visualizing? Try resizing the browser window.</p>
</div>
</div>
</div>
</div>

<!-- The example MOF selection section of the website -->
<div id="pills-example" style='font-size: 20px;' class='zebra'>
  Choose the default MOF HKUST-1 or any CoRE MOF.

  <!-- Selection box for the example MOF -->
  <div style="padding-top: 30px; font-size: 22px;" class='zebra'>
    Example MOF options
    <input autocomplete="off" style='font-size: 22px;' id="MOF_option" class='form-control locksMetrics' list='MOFs_list'
    onmousedown="value = '';" />
  </div>

  <!-- Default linkers -->
  <datalist id='MOFs_list' style='font-size: 22px;'>
    <!-- Defined near the end of the Javascript section below -->
  </datalist>

  <div style='width:100%; text-align:center; margin-top:0.5cm;'>

    <button style='display:inline-block; width:49%; font-size: 22px;' class='btn btn-primary round_button'
    id='select_example' type='button'>Select example MOF</button>
  </div>

</div>

<!-- The building block section of the website -->
<div id="pills-bb" style='font-size: 20px;' class='zebra'>
  A way for the user to generate MOFs for analysis, using a topological MOF net and nodular and connecting building
  blocks (bb). <br>

  Not every combination of linker, SBU, and net is compatible. <br>

  Special thanks to the G&oacutemez-Gualdr&oacuten and Snurr groups for developing MOF building block assembly code.
  <br>

  For information on net (topology) abbreviations, refer to 10.1021/acs.cgd.7b00848 and 10.1039/c8ce01637b.

  <!-- Selection box for the linker building block -->
  <div style="padding-top: 30px; font-size: 22px;" class='zebra'>
    Linker, the connecting building block
    <input style='font-size: 22px;' id="linker_option" class='form-control locksMetrics' list='linkers_list'
    onmousedown="value = '';" />
  </div>

  <!-- Default linkers -->
  <datalist id='linkers_list' style='font-size: 22px;'>
    <!-- Defined near the end of the Javascript section below -->
  </datalist>

  <!-- Selection box for metal SBU building block -->
  <div style='font-size: 22px;' class='zebra'>
    SBU, the metal-centered nodular building block
    <input style='font-size: 22px;' id="sbu_option" class='form-control locksMetrics' list='sbus_list'
    onmousedown="value = '';" />
  </div>

  <!-- Default sbus -->
  <datalist id='sbus_list'>
    <!-- Defined near the end of the Javascript section below -->
  </datalist>

  <div style='font-size: 22px;'>
    MOF Net
    <input style='font-size: 22px;' id="nets_option" class='form-control locksMetrics' list='nets_list'
    onmousedown="value = '';" />
  </div>

  <!-- Default nets -->
  <datalist id='nets_list'>
    <!-- Defined near the end of the Javascript section below -->
  </datalist>

  <div style='width:100%; text-align:center; margin-top:0.5cm;'>

    <button style='display:inline-block; width:49%; font-size: 22px;' class='btn btn-primary round_button'
    id='generate' type='button'>Make bb-generated MOF</button>
    <button style='display:inline-block; width:49%; font-size: 22px;' class='btn btn-primary round_button'
    id='download_generated' type='button'>Download bb-generated MOF</button>
  </div>

</div>


<!-- The Data Upload tab of the website -->  
<div id="pills-data" class="container">

  <div class="col-12" id="upload_form">

    <form class='col-10' style='font-size:22px;margin-left:15px' id='upload_form_element' action='/process_feedback' method="POST" enctype="multipart/form-data">
      <i class='zebra'>Upload information on your MOF!</i>
      <input type="hidden" name="feedback_form_name" value="upload_form" />
      <input type="hidden" name="cif_file_name" value="" />
      <input type="hidden" name="structure" value="" />
      <input type="hidden" name="rating" value="" />
      <div style="" class="input-group mt-2">
        <div class="input-group-prepend">
          <span class="input-group-text" id="upload_form_email_desc">Email (.edu preferred) *</span>
        </div>
        <input name="email" type="email" id="upload_form_email" aria-describedby="upload_form_email_desc"
        class="form-control" required>
      </div>
      <div class="input-group mt-2" style="">
        <div class="input-group-prepend">
          <span class="input-group-text" id="upload_form_comments_desc">Comments</span>
        </div>
        <input name="comments" type="text" id="upload_form_comments" aria-describedby="upload_form_comments_desc"
        class="form-control">
      </div>
      <div class="custom-file form-control mt-2">
        <input name="cif_file" type="file" class="custom-file-input" id="validatedCustomFile_E1" required>
        <label class="custom-file-label" for="validatedCustomFile_E1" id="MOF_E">Upload MOF (.cif) *</label>
        <div class="invalid-feedback">Example invalid custom file feedback</div>
      </div>
      <div class="custom-file form-control mt-2">
        <input name="file" type="file" class="custom-file-input" id="validatedCustomFile_E2" required>
        <label class="custom-file-label" for="validatedCustomFile_E2" id="TGA_E">Upload TGA Trace (.pdf, .jpg, .png,
        .tiff; 20 MB max) *</label>
        <div class="invalid-feedback">Example invalid custom file feedback</div>
      </div>
      <div class="input-group mt-2" style="">
        <div class="input-group-prepend">
          <span class="input-group-text" id="data_upload_solvname_desc">Solvent evacuated from MOF *</span>
        </div>
        <input name="solvent" type="text" id="data_upload_solvname" aria-describedby="data_upload_solvname_desc"
        class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary mt-2" id="submit_E">Submit</button>
    </form>

    <form class='col-10' style='font-size:22px;margin-left:15px' id='removal_form_element' action='/process_removal' method="POST" enctype="multipart/form-data">
      <i class='zebra'>Request information removal from our databases</i>
      <div style="" class="input-group mt-2">
        <div class="input-group-prepend">
          <span class="input-group-text" id="removal_form_email_desc">Email (.edu preferred) *</span>
        </div>
        <input name="email" type="email" id="removal_form_email" aria-describedby="removal_form_email_desc"
        class="form-control" required>
      </div>
      <div class="input-group mt-2" style="">
        <div class="input-group-prepend">
          <span class="input-group-text" id="removal_form_comments_desc">Describe entry to remove (date uploaded, type of MOF, etc) *</span>
        </div>
        <input name="comments" type="text" id="removal_form_comments" aria-describedby="removal_form_comments_desc"
        class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary mt-2" id="submit_F">Submit</button>
    </form>

  </div>
</div>

</div>



<div class="navbar navbar-expand-lg relative navbar-dark bg-primary" style="margin-top: 50px; font-size: 24px;">
  <div class="container">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link disabled">Site developed and maintained by the Kulik Group at MIT</br> Contact: mofsimplify@mit.edu</a>
      </li>
    </ul>
  </div>
</div>

<!-- For cif file upload -->
<input id="file_input" type="file" name="file_input" style="display:none" />
<!-- This will never display anything. Just used to store a MOF cif file if the button "Custom (upload cif file)" is used. -->

<!-- For example MOF file -->
<p id="example_holder"> </p>
<!-- This will never display anything. Just used to store a MOF cif file if the button "Example MOF" is used. -->

<!-- For building block-generated MOF file -->
<p id="bbg_MOF_holder"> </p>
<!-- This will never display anything. Just used to store a MOF if the button "Make bb-generated MOF" is used. -->

<!-- For MOF components (xyz file text) -->
<p id="components_holder"> </p>
<!-- This will never display anything. Just used to store components if the button "Get selected (1) MOF components" is used. -->

<!-- For solvent removal stability ANN nearest neighbors -->
<p id="solvent_neighbors_holder"> </p>
<!-- This will never display anything. Just used to store ANN nearest neighbors if the button "Stability upon solvent removal" is used. -->

<!-- For thermal stability ANN nearest neighbors -->
<p id="thermal_neighbors_holder"> </p>
<!-- This will never display anything. Just used to store ANN nearest neighbors if the button "Thermal stability" is used. -->

</body>



<!-- Beginning of JavaScript section -->
<script>

  // Lots of this code is from sbu.html at https://github.com/snurr-group/web-mofid, for MOF visualization.

  // ***** Beginning of section with a lot of copied code from the Snurr group's GitHub. *****
  // With some modifications for our purposes, specifically in the handleInput function. Also, the OOM message. 

  var stage;

  // Variables below: used for MOF visualization re-tries if OOM error appears
  var vis_error_counter = 0;
  var vis_failure = false;
  var MAX_VIS_ERROR = 3; // maximum number of times a MOF can fail to be visualized before error message is displayed
  var solvent_neighbor_vis = false
  var thermal_neighbor_vis = false
  //

  var lsdir = function (path) {
    return FS.readdir(path).filter(function (e) {
      return !['..', '.'].includes(e);  // filter out current and parent dirs
    }).sort();
  };

  // Adapted from examples at http://nglviewer.org/ngl/api/manual/usage/embedding.html
  // and https://codepen.io/pen?template=JNLMXb and http://nglviewer.org/ngldev/api/manual/snippets.html
  document.addEventListener("DOMContentLoaded", function () {
    stage = new NGL.Stage("cifviewport");
    stage.setParameters({ backgroundColor: "white" });
  });

  var runMOFidCode = function (cifdata) {
    C_obcode = Module.cwrap(
      'analyzeMOFc', 'null', ['string', 'number', 'number']
      );

    if (!FS.analyzePath('/Output').exists) {
      FS.mkdir('/Output');  // See also docs on filesystem API: https://kripken.github.io/emscripten-site/docs/api_reference/Filesystem-API.html
      // Ideally, the C_obcode executable would automatically make all of the directories,
      // but it's broken at least in an old version of Emscripten.
      FS.mkdir('/Output/MetalOxo');
      FS.mkdir('/Output/SingleNode');
      FS.mkdir('/Output/AllNode');
      FS.mkdir('/Output/StandardIsolated');
    }

    var buflen = 65536;
    var ptr = Module._malloc(buflen);
    var buffer = new Uint8Array(Module.HEAPU8.buffer, ptr, buflen); // Get a bytes view on the newly allocated buffer.
    C_obcode(cifdata, ptr, buflen);
    var ans = Module.UTF8ToString(ptr);
    Module._free(ptr);
    return ans;
  };

  var analyzeMOF = function (input_cif_str, cif_name) {
    // Get relevant MOFid/MOFkey information from an input string of CIF-formatted coordinates
    var raw_mofid_output = runMOFidCode(input_cif_str);
    var single_node_topology = getTopology("/Output/SingleNode/topology.cgd");
    var all_node_topology = getTopology("/Output/AllNode/topology.cgd");

    // Extract the MOFid, per run_mofid.py:cif2mofid
    const fragment_info = _extractFragments(raw_mofid_output);
    let mofid_topology = '';
    if (fragment_info.cat == null) {
      mofid_topology = 'NA'
    } else if (single_node_topology == all_node_topology) {
      mofid_topology = single_node_topology;
    } else {
      mofid_topology = single_node_topology + ',' + all_node_topology;
    }

    let mof_name = cif_name;
    if (cif_name.endsWith('.cif') || cif_name.endsWith('.CIF')) {
      mof_name = cif_name.substring(0, cif_name.length - 4);
    }
    const all_fragments = fragment_info.nodes.concat(fragment_info.linkers);
    all_fragments.sort();

    // Assembling the MOFid from id_constructor.py:assemble_mofid
    let mofid = all_fragments.join('.');
    mofid += ' MOFid-v1.';
    mofid += mofid_topology + '.';
    if (fragment_info.cat == 'no_mof') {
      mofid += fragment_info.cat
    } else if (fragment_info.cat != null) {
      mofid += 'cat' + fragment_info.cat;
    } else {
      mofid += 'NA';
    }
    if (mofid.startsWith(' ')) {  // Null linkers.  Make .smi compatible
      mofid = '*' + mofid + 'no_mof';
    }
    mofid += ';' + mof_name;

    // Extract the MOFkey
    var base_mofkey = "";
    if (fragment_info.parsed) {
      base_mofkey = FS.readFile("/Output/MetalOxo/mofkey_no_topology.txt", { 'encoding': 'utf8' });
    }
    var mofkey = base_mofkey.replace('MOFkey-v1', 'MOFkey-v1.' + single_node_topology);

    return {
      raw_output: raw_mofid_output,
      mofid: mofid,
      mofkey: mofkey,
      fragments: fragment_info
    };
  }

  var _extractFragments = function (raw_mofid_output) {
    // Parse the MOFid output, per id_constructor.py:extract_fragments
    let all_fragments = raw_mofid_output.trim().split(/\r\n|\r|\n/g);
    all_fragments = all_fragments.map(a => a.trim());
    if (all_fragments == '') {
      return { nodes: ['*'], linkers: [], cat: cat, parsed: false };
    }

    const cat_num_line = all_fragments.pop();
    let cat = null;
    if (cat_num_line.includes('simplified net(s)')) {
      cat = (parseInt(cat_num_line[8]) - 1).toString();  // '# Found x simplified net(s)'
      if (cat == '-1') {
        cat = null;
      }
    } else {
      all_fragments = ['*'];
    }

    // Parse node/linker fragment notation
    if (all_fragments[0] != '# Nodes:') {
      return { nodes: ['*'], linkers: [], cat: cat, parsed: false };
    }
    all_fragments.shift();
    const linker_flag_loc = all_fragments.findIndex(line => (line == "# Linkers:"));
    const node_fragments = all_fragments.slice(0, linker_flag_loc);
    const linker_fragments = all_fragments.slice(linker_flag_loc + 1);
    node_fragments.sort();
    linker_fragments.sort();

    return { nodes: node_fragments, linkers: linker_fragments, cat: cat, parsed: true };
  }

  var rawToSmiles = function (raw_mofid) {
    // Converts the raw output from the MOFid code to a parseable SMILES format
    var lines = raw_mofid.replace(/\t/g, '').split(/\r\n|\r|\n/g);  // remove trailing tabs before splitting
    lines.pop();  // remove line about number of simplified nets
    return lines.join('.');
  }

  handleInput = function (s_neighbor, t_neighbor) {

    // s_neighbor and t_neighbor are booleans, indicate if we are visualizing a neighbor
    // if not, default to visualize the MOF that is queued up

    if (s_neighbor) { // In this case, want to visualize the solvent removal stability ANN neighbor
      // grab the current solvent neighbor MOF cif file

      my_neighbor = $('#solvent_neighbors').val(); // select the solvent removal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      fetch('CoRE2019/' + my_neighbor + '.cif').then(response => { // grabbing the MOF from local host
        if (!response.ok) { // catching 404 and other issues
          throw Error(response.statusText);
        }
        return response.blob();
      }).then(function (blob) {
        var ciffile = new File([blob], "solvent_neighbor.cif", { type: "", lastModified: Date.now() }) // making a cif file
        handleVisualization(ciffile)

      }).catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
      })

    }
    else if (t_neighbor) { // In this case, want to visualize the thermal stability ANN neighbor

      // grab the current solvent neighbor MOF cif file

      my_neighbor = $('#thermal_neighbors').val(); // select the thermal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      fetch('CoRE2019/' + my_neighbor + '.cif').then(response => { // grabbing the MOF from local host
        if (!response.ok) { // catching 404 and other issues
          throw Error(response.statusText);
        }
        return response.blob();
      }).then(function (blob) {
        var ciffile = new File([blob], "thermal_neighbor.cif", { type: "", lastModified: Date.now() }) // making a cif file
        handleVisualization(ciffile)

      }).catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
      })

    }
    else { // Visualize the queued up MOF (either the default MOF, the uploaded MOF, or the building block MOF)
      // Code elsewhere in this file makes it so only one of the three will be available, if any of them are available

      if (document.getElementById("file_input").files[0] !== undefined) {
        var ciffile = document.getElementById("file_input").files[0];
      }
      else if (document.getElementById("example_holder").value !== null) {
        var ciffile = document.getElementById("example_holder").value;
      }
      else {
        var ciffile = document.getElementById('bbg_MOF_holder').value;
      }
    }

    handleVisualization(ciffile)
  }

  handleVisualization = function (ciffile) {
    var cifreader = new FileReader();
    cifreader.onload = function (event) {
      var mofid_results = analyzeMOF(event.target.result, ciffile.name);
      if (mofid_results.fragments.parsed) {
        const mofid_html = "<div>MOFid:<br /><code>" + mofid_results.mofid + "</code></div>";
        const mofkey_html = "<div>MOFkey:<br /><code>" + mofid_results.mofkey + "</code></div>";
        updateFileLists();  // populate the initial list of files
        document.getElementById("viewportnote").style.display = "none";
        document.getElementById("viewportwrapper").classList.remove("inactive");

        clearViewer(stage);
        drawEmPDB(stage, "/Output/orig_mol.pdb");
      } else {
        document.getElementById("viewportwrapper").classList.add("inactive");
      }
    };

    // The below try-catch fixes a Chrome issue for visualizing neighbors (Uncaught TypeError: Failed to execute 'readAsText' on 'FileReader': parameter 1 is not of type 'Blob'.)
    try {
      cifreader.readAsText(ciffile);
    }
    catch (e) {
    }
  }

  getTopology = function (path_to_cgd) {
    // Extract topology from a generated CGD simplified net
    const raw_rcsr_extract = FS.readFile("/RCSRnets.arc", { 'encoding': 'utf8' });
    const raw_cgd = FS.readFile(path_to_cgd, { 'encoding': 'utf8' });
    if (!raw_cgd.includes('NODE')) {
      return "ERROR";  // not a MOF: no node building blocks found!
    } else {
      return webGavrog.getRawRCSRTopology(raw_cgd, raw_rcsr_extract);
    }
  }

  updateFileLists = function () {
    //clearDropdown("cifdownload");
    var folder_name = "";//getInputValue("folderdownload");
    var selected_view_index = "none";//document.getElementById("view_type").selectedIndex;

    var filelist;
    var view_value_list = ["original", "nodes_and_linkers", "simplified_net"];
    var view_name_list = ["Original MOF", "Nodes + Linkers", "Simplified topology"];
    if (folder_name == "") {  // original base directory
      filelist = ["orig_mol.cif", "orig_mol.pdb"];
      // Only keeping the original MOF in the viewer types:
      view_value_list = [view_value_list[0]];
      view_name_list = [view_name_list[0]];
      selected_view_index = "0";
    } else {
      filelist = lsdir("/Output/" + folder_name);
      // Removing the original MOF from the viewer types:
      view_value_list.shift();
      view_name_list.shift();
    }
    if (folder_name == "AllNode") {
      // Separate linkers into branches + branch points for the AllNode algorithm
      view_value_list[0] = "nodes_and_branches";
    }
  }

  clearViewer = function (ngl_stage) {
    ngl_stage.removeAllComponents();
  }

  addPDBtoViewer = function (ngl_stage, path_to_cif, color_scheme = "element") {
    var component;
    ngl_stage.loadFile(path_to_cif, { ext: "pdb" }).then(function (o) {
      o.addRepresentation("ball+stick", { colorScheme: color_scheme });
      o.addRepresentation("unitcell");
      o.autoView();
      /* See class documentation at http://nglviewer.org/ngl/api/class/src/stage/stage.js~Stage.html */
      /* See also the general documentation at http://nglviewer.org/ngl/api/manual/ */
    });
    return component;
  }

  drawEmPDB = function (ngl_stage, emscripten_path, color_scheme = "element") {
    var cif_string = FS.readFile(emscripten_path, { 'encoding': 'utf8' });
    var temp_file = new Blob([cif_string], { type: 'chemical/x-cif' });
    return addPDBtoViewer(ngl_stage, temp_file, color_scheme);
  }


  var Module = {
    preRun: [],
    postRun: [],
    print: (function () {
      var element = document.getElementById('output');
      if (element) element.value = ''; // clear browser cache
      return function (text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        if (element) {
          element.value += text + "\n";
          element.scrollTop = element.scrollHeight; // focus on bottom
        }
      };
    })(),
    printErr: function (text) {
      if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
      if (0) { // XXX disabled for safety typeof dump == 'function') {
        dump(text + '\n'); // fast, straight to the real console
      } else {
        console.error(text);
      }
    },
    canvas: (function () {

      // As a default initial behavior, pop up an alert when webgl context is lost. To make your
      // application robust, you may want to override this behavior before shipping!
      // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2

      return null;
    })(),
    setStatus: function (text) {
      if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
      if (text === Module.setStatus.text) return;
      var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
      var now = Date.now();
      if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
      if (m) {
        text = m[1];
      } 
    },
    totalDependencies: 0,
    monitorRunDependencies: function (left) {
      this.totalDependencies = Math.max(this.totalDependencies, left);
      Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
    }
  };
  Module.setStatus('Downloading...');

  // If the user chooses to try to visualize a MOF (either the selected MOF or a neighbor MOF), visualization is attempted by the website three times
  // This is because OOM errors are sometimes thrown upon visualization, but upon retrying, visualization often succeeds
  // A cap of three is used because some MOFs will always fail visualization (if their unit cell from the cif is too large, or this code just doesn't like them)
  // After three failed tries, an error alert is shown to the user
  window.onerror = function (event) {
    if (vis_error_counter == MAX_VIS_ERROR) {
      //Module.setStatus('Exception thrown in visualization; please retry the operation.');
      document.getElementById("viewportnote").innerHTML = "Visualization failed";
      alert('MOF cannot be visualized.') // out of memory (OOM). Exception thrown in visualization
      // $('#status_visualization').text('Exception thrown in visualization; please retry the operation.'); 

      $('#currently_visualized').text(''); // clear the message about which MOF is visualized if OOM occurs

      // visualize_color = failure_red;
      // $('#visualize').css({'background-color': failure_red, 'border-color': failure_red}); // setting button color to indicate failure

      Module.setStatus = function (text) {
        if (text) Module.printErr('[post-exception status] ' + text);
      };

    }
    else {
      vis_error_counter += 1
      vis_failure = true

      handleInput(solvent_neighbor_vis, thermal_neighbor_vis); // handles visualization, will display the MOF in the appropriate box (viewportwrapper) 
    }
  };

  // ***** End of section with a lot of copied code. *****


  // tags for changing the selection button colors, depending on if an operation is successfully completed or not
  failure_red = '#A33B20';
  success_green = '#18bc9c';
  inprogress_yellow = '#F7B801'
  original_blue = '#2c3e50';

  load_color = original_blue;
  upload_color = original_blue;
  bb_redirect_color = original_blue;
  solvent_pred_color = original_blue;
  thermal_pred_color = original_blue;
  visualize_color = original_blue
  component_color = original_blue

  $(function () {


    // Set up 3Dmol viewer 
    let element = $('#container-01');
    let config = { backgroundColor: 'white' };
    let component_viewer = $3Dmol.createViewer(element, config);
    data = {};

    // Reset zoom level.
    $('#reset_zoom').click(function () {
      component_viewer.zoomTo();
    })

    // Reset certain fields when a new MOF is uploaded (either the example MOF or a user-specified MOF) or generated with building blocks.
    function renew(action) { // something else was already called reset, so we're calling this renew

      // action will be either 'example', 'input', or 'bb'
      if (action != 'example') {
        document.getElementById('example_holder').value = null; // clears example cif
      }
      if (action != 'input') {
        document.getElementById('file_input').value = null; // clearing any cifs loaded by the user
      }
      if (action != 'bb') {
        document.getElementById('bbg_MOF_holder').value = null; // clearing bb-generated MOFs holder
      }

      color_reset(); // resetting selection and prediction and visualize and component button colors 

      s_stability_field = document.getElementById('solvent_stability_prediction');
      setColor(s_stability_field, 'transparent') // color background, transparent                      

      t_stability_field = document.getElementById('thermal_stability_prediction');
      setColor(t_stability_field, 'transparent') // color background, transparent                      

      // hiding sections
      // $('#predict_section').hide()
      $('#predict_section').hide()
      $('#neighbor_blurb').hide()
      $('#solvent_neighbor_section').hide()
      $('#thermal_neighbor_section').hide()
      $('#status_section').hide()
      $('#descriptor_section').hide()
      $('#solvent_form').hide()
      $('#thermal_form').hide()
      $('#solvent_neighbor_form').hide()
      $('#thermal_neighbor_form').hide()
      $('#cif_hint').hide()

      // clearing previous predictions
      $('#solvent_stability_prediction').text('');
      $('#thermal_stability_prediction').text('');
      $('#thermal_stability_percentile').text('');

      // Clearing everything in the Status messages and MOF predictions section of the website, and the holders. Also clearing SMILES strings of components.
      $('#currently_visualized').text('');
      $('#upload_status').text(''); // now nothing is uploaded
      $('#chart').text('');
      $('#tga_plot').text('');
      $('#s_neighbor_info').text('');
      $('#t_neighbor_info').text('');
      $('#comp_MOF').text('')
      $('#component_SMILES').text(''); // clear the SMILES string of any component that was present
      $('#resize_hint').hide()
      document.getElementById('toggle_unique_components').textContent = 'Filter by connectivity'; // setting button text
      document.getElementById('solvent_neighbors_holder').value = undefined
      document.getElementById('thermal_neighbors_holder').value = undefined
      document.getElementById('components_holder').value = undefined; // clearing the value, so no component visualization is possible
      $('#tga_explanation').hide() // hide the explanatory TGA graphic on simplified TGA plots

      // Clearing visualizations and dropdowns.
      clearViewer(stage); // no MOF is displayed in the visualizer now
      component_viewer.clear(); // likewise, clear component visualizer
      clear_component_dropdowns();
      clear_neighbor_dropdowns(); // clear the nearest neighbor dropdowns

      // Re-display messages in the two visualizers.
      document.getElementById('viewportnote').style.display = 'block';
      document.getElementById('viewportnote').innerHTML = 'MOF unit cells are visualized here. <br> Left click to rotate, right click with mouse to move, scroll with mouse to zoom.';
      document.getElementById('container-01-note').innerHTML = 'MOF linkers and SBUs are visualized here. <br> Left click to rotate, scroll with mouse to zoom.';

      // Reset forms
      document.getElementById('solvent_stability_feedback').reset()
      document.getElementById('thermal_stability_feedback').reset()
      document.getElementById('solvent_stability_neighbor_feedback').reset()
      document.getElementById('thermal_stability_neighbor_feedback').reset()
      $("#TGA_A").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text (solvent stability)
      $("#TGA_B").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text (thermal stability)
      $("#TGA_C").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text (solvent stability neighbor)
      $("#TGA_D").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text (thermal stability neighbor)
    }

    // Resets the colors of the selection and prediction and visualize and component buttons
    function color_reset() { 
      load_color = original_blue;
      upload_color = original_blue;
      bb_redirect_color = original_blue;
      solvent_pred_color = original_blue;
      thermal_pred_color = original_blue;
      visualize_color = original_blue;
      component_color = original_blue
      descriptor_color = original_blue;

      $('#example-redirect').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#upload').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#bb-redirect').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#predict_s').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#predict_t').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#visualize').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#get_components').css({ 'background-color': original_blue, 'border-color': original_blue })
      $('#download_descriptors').css({ 'background-color': original_blue, 'border-color': original_blue })

    }

    // Used for ensuring that only .cif files are uploaded.  
    function getExtension(filename) {
      var parts = filename.split('.');
      return parts[parts.length - 1];
    }

    // Used for ensuring that only .cif files are uploaded.
    function isCif(filename) {
      var ext = getExtension(filename);
      return ext == 'cif';
    }

    // Upload MOF cif file.  
    $('#upload').on('click', function () { // button triggers upload
      $('#file_input').trigger('click'); // OS file selection
    });

    // This function triggers once the user uploads a file.
    $("#file_input").change(function () {
      renew('input');

      // Check if uploaded file is a .cif.
      if (!isCif(this.value)) { // if the uploaded file is not a cif
        this.value = null; // clear the non-cif file
        upload_color = failure_red;
        $('#upload').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
        alert("Must be a cif file.");
        return; // if not a cif, doesn't continue     
      }

      let myFile = document.getElementById('file_input').files[0]; // the uploaded file
      $('#upload_status').text('Selected MOF (uploaded): ' + myFile.name);
      upload_color = success_green;
      $('#upload').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success
      $('#predict_section').show()
      $('#status_section').show()
      $('#cif_hint').show()
    });

    // Code that updates the file upload text in any input form (i.e. change "Upload file..." to "file.pdf")
    $('input[type="file"]').change(function(e){
      var fileName = e.target.files[0].name;
      $(e.target).siblings('.custom-file-label').html(fileName);
    });

    // This function triggers when someone clicks the "Visualize selected (1) MOF" button.
    $("#visualize").on('click', function () {
      vis_error_counter = 0 // used to track how many failed visualizations in a row for one MOF
      vis_failure = false // used to track if OOM error is thrown for this MOF
      // visualize_color = inprogress_yellow; // could not get this to work
      // $('#visualize').css({'background-color': inprogress_yellow, 'border-color': inprogress_yellow}); // setting button color to indicate in progress

      clearViewer(stage); // no MOF is displayed in the visualizer now

      let myFile = document.getElementById('file_input').files[0]; // the uploaded file
      let myFile2 = document.getElementById('example_holder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbg_MOF_holder').value; // the generated MOF, if Make bb-generated MOF has been used

      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile == null && myFile2 == null && myFile3 == null) {
        alert("Must select a MOF for analysis first.");
        visualize_color = failure_red;
        $('#visualize').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
        return;
      }

      // alert('Visualization loading, may take up to 30 seconds. Close this alert after reading.') // timing upper limit based on NaX.cif

      document.getElementById("viewportnote").innerHTML = "Loading visualization...";

      solvent_neighbor_vis = false
      thermal_neighbor_vis = false
      handleInput(solvent_neighbor_vis, thermal_neighbor_vis); // handles visualization, will display the MOF in the appropriate box (viewportwrapper)

      name = get_selected_MOF();

      message = 'Currently visualized MOF: '
      message = message + name

      $('#currently_visualized').text(message);

      visualize_color = original_blue;
      $('#visualize').css({ 'background-color': original_blue, 'border-color': original_blue }); // setting button color
      // visualize_color = success_green;
      // $('#visualize').css({'background-color': success_green, 'border-color': success_green}); // setting button color to indicate success
      // $('status_visualization').text(''); // clear the OOM message

    })

    // This function triggers when someone clicks the "Visualize" button in the solvent section. 
    $("#visualize_s_neighbor").on('click', function () {
      vis_error_counter = 0 // used to track how many failed visualizations in a row for one MOF
      vis_failure = false // used to track if OOM message is thrown for this MOF
      clearViewer(stage); // no MOF is displayed in the visualizer now

      // Ensure there are neighbors to display information on
      if (document.getElementById('solvent_neighbors_holder').value == undefined) {
        alert('Must make solvent removal stability prediction first.');
        return;
      }

      if (document.getElementById('solvent_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      alert('Visualization loading, may take up to 30 seconds. Close this alert after reading.') // timing upper limit based on NaX.cif

      $('#pills-vis-tab').click() // redirecting to appropriate tab

      document.getElementById("viewportnote").innerHTML = "Loading visualization...";

      solvent_neighbor_vis = true
      thermal_neighbor_vis = false
      handleInput(solvent_neighbor_vis, thermal_neighbor_vis); // handles visualization, will display the MOF in the appropriate box (viewportwrapper)


      my_neighbor = $('#solvent_neighbors').val(); // select the solvent removal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      message = 'Currently visualized MOF: '
      message = message + my_neighbor

      $('#currently_visualized').text(message);

      visualize_color = original_blue;
      $('#visualize').css({ 'background-color': original_blue, 'border-color': original_blue }); // setting button color 
    })

    // This function triggers when someone clicks the "Visualize" button in the thermal section. 
    $("#visualize_t_neighbor").on('click', function () {
      vis_error_counter = 0 // used to track how many failed visualizations in a row for one MOF
      vis_failure = false // used to track if OOM message is thrown for this MOF
      clearViewer(stage); // no MOF is displayed in the visualizer now

      // Ensure there are neighbors to display information on
      if (document.getElementById('thermal_neighbors_holder').value == undefined) {
        alert('Must make thermal stability prediction first.');
        return;
      }

      if (document.getElementById('thermal_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      alert('Visualization loading, may take up to 30 seconds. Close this alert after reading.') // timing upper limit based on NaX.cif

      $('#pills-vis-tab').click() // redirecting to appropriate tab

      document.getElementById("viewportnote").innerHTML = "Loading visualization...";

      solvent_neighbor_vis = false
      thermal_neighbor_vis = true
      handleInput(solvent_neighbor_vis, thermal_neighbor_vis); // handles visualization, will display the MOF in the appropriate box (viewportwrapper)


      my_neighbor = $('#thermal_neighbors').val(); // select the thermal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      message = 'Currently visualized MOF: '
      message = message + my_neighbor

      $('#currently_visualized').text(message);

      visualize_color = original_blue;
      $('#visualize').css({ 'background-color': original_blue, 'border-color': original_blue }); // setting button color 
    })

    // Generate solvent removal stability prediction when the "Stability upon solvent removal" button is clicked.
    $('#predict_s').click(function () {
      // check if a cif is uploaded
      let myFile = document.getElementById('file_input').files[0]; // the uploaded file
      let myFile2 = document.getElementById('example_holder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbg_MOF_holder').value; // the generated MOF, if Make bb-generated MOF has been used

      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile == undefined) {
        myFile = myFile2;
        if (myFile2 == undefined) {
          myFile = myFile3;
          if (myFile3 == undefined) {
            alert("Must select a MOF for analysis first.");

            solvent_pred_color = failure_red;
            $('#predict_s').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure

            return;
          }
        }
      }

      // alert('Prediction loading, please wait for a few seconds. Close this alert after reading.') 

      $('#solvent_stability_prediction').text('The solvent removal stability prediction is loading...');

      solvent_pred_color = inprogress_yellow;
      $('#predict_s').css({ 'background-color': inprogress_yellow, 'border-color': inprogress_yellow }); // setting button color to indicate in progress

      // getting the name of the selected MOF
      var name = document.getElementById('upload_status').innerHTML;
      name = name.split(' ');
      name = name.slice(-1)[0]; // getting the last element of the array

      // myFile.text() is a promise
      myFile.text().then(function (result) {
        // result is the text of the loaded .cif file

        myDict = { 'name': name, 'structure': result }

        // The $ is jquery. The post stuff sends a command to the app.py code to execute the function that is routed to by /predict_solvent_stability
        // It is a post request rather than a get request because information is sent to the backend (in a get request no information is sent)
        $.post("/predict_solvent_stability", JSON.stringify(myDict)).done(
          function (response) {

            if (response == 'OVERLOAD') {
              alert('Server is receiving high traffic, please try again later')
              solvent_pred_color = failure_red;
              $('#predict_s').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
              $('#solvent_stability_prediction').text('');

              return; // Do not update solvent removal stability prediction if server is too busy.              
            }
            if (response == 'FAILED') {
              alert('Failed to featurize')
              solvent_pred_color = failure_red;
              $('#predict_s').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
              $('#solvent_stability_prediction').text('');

              return; // Do not update solvent removal stability prediction if prediction failed.
            }

            solvent_pred_color = success_green;
            $('#solvent_form').show() // Show the feedback form
            $('#solvent_form input[name=cif_file_name]').val(myDict['name']);
            $('#solvent_form input[name=structure]').val(myDict['structure']); // Populate the feedback form with metadata
            $('#predict_s').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success

            $('#neighbor_blurb').show() // show nearest neighbors section
            $('#solvent_neighbor_section').show()
            $('#descriptor_section').show() // show section where can download descriptors

            // There are two possibilities. Either a prediction is made, or the selected MOF is in the ANN's training data and so no prediction is made and instead the ground truth is returned.
            if (!response['in_train']) { // a prediction was made
              var prediction = response['prediction']

              // preparing the human-interpretable solvent removal stability prediction
              if (prediction <= 0.2) {
                verdict = 'Very confident the MOF is unstable upon solvent removal.';
                my_color = '#ffad97' // color background, light red
              }
              else if (prediction <= 0.4) {
                verdict = 'Fairly confident the MOF is unstable upon solvent removal.';
                my_color = '#ffcd97' // light orange
              }
              else if (prediction <= 0.5) {
                verdict = 'Uncertain, but predict the MOF is unstable upon solvent removal.';
                my_color = '#fffa97' // light yellow
              }
              else if (prediction <= 0.6) {
                verdict = 'Uncertain, but predict the MOF is stable upon solvent removal.';
                my_color = '#fffa97' // light yellow
              }
              else if (prediction <= 0.8) {
                verdict = 'Fairly confident the MOF is stable upon solvent removal.';
                my_color = '#e7ff97' // light lime
              }
              else {
                verdict = 'Very confident the MOF is stable upon solvent removal.';
                my_color = '#90ee90' // light green
              }

              $('#solvent_stability_prediction').text('The solvent removal stability prediction is: ' + prediction.toString() + '. ' + verdict);

              stability_field = document.getElementById('solvent_stability_prediction');
              solvent_form = document.getElementById('solvent_form');
              setColor(stability_field, my_color) // color background based on the prediction
              setColor(solvent_form, my_color);

              // Now that the prediction has been displayed, can move on to the neighbors display.
              var neighbor_names = response['neighbor_names']
              var neighbor_distances = response['neighbor_distances']

              // Convert these arrays into a dictionary called neighbors.
              var neighbors = {}
              for (i = 0; i < neighbor_names.length; i++) {
                neighbors[neighbor_names[i]] = neighbor_distances[i]
              }

              // Storing the information on the neighbors.
              document.getElementById('solvent_neighbors_holder').value = neighbors;

              // Populating the solvent neighbors dropdown.
              var solvent_dropdown = document.getElementById("solvent_neighbors");

              // clear dropdown
              var length = solvent_dropdown.options.length;
              for (i = length - 1; i >= 0; i--) {
                solvent_dropdown.options[i] = null;
              }

              // Populating the solvent neighbors dropdown.
              for (i = 0; i < neighbor_names.length; i++) {
                var option = document.createElement('option');
                var num = String(i + 1)
                num = num.concat('. ') // formatting to make it look like a list
                option.text = num.concat(neighbor_names[i]);
                solvent_dropdown.add(option);
              }

              // Setting text in the feedback form.
              $('#rate_solvent').text('Rate this prediction *')
            }
            else { // requested MOF was in the training data

              // Storing information indicating that a prediction was made, but no neighbors are available
              document.getElementById('solvent_neighbors_holder').value = 1

              stability_field = document.getElementById('solvent_stability_prediction');
              solvent_form = document.getElementById('solvent_form');

              if (response['truth'] == 1) {
                $('#solvent_stability_prediction').text('This MOF is in the training data and is reported to be stable upon solvent removal.');
                setColor(stability_field, '#90ee90') // color background, light green
                setColor(solvent_form, '#90ee90') // color background, light green
              }
              else {
                $('#solvent_stability_prediction').text('This MOF is in the training data and is reported to be unstable upon solvent removal.');
                setColor(stability_field, '#ffad97') // color background, light red
                setColor(solvent_form, '#ffad97') // color background, light red
              }

              // Setting text in the feedback form.
              $('#rate_solvent').text('Rate this ground truth *')
            }

          })
          .fail(function(xhr, textStatus, errorThrown) { // for timeout error; triggers after 1 minute
            solvent_pred_color = failure_red;
            $('#predict_s').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
            $('#solvent_stability_prediction').text('');
            alert(errorThrown.concat("; MOF may be too large for web-based analysis"))
          })
        })
});


function setColor(element, color) {
  element.style.backgroundColor = color;
}

    // Generate thermal stability prediction when the "Thermal stability" button is clicked.
    $('#predict_t').click(function () {
      // check if a cif is uploaded
      let myFile = document.getElementById('file_input').files[0]; // the uploaded file
      let myFile2 = document.getElementById('example_holder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbg_MOF_holder').value; // the generated MOF, if Make bb-generated MOF has been used

      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile == undefined) {
        myFile = myFile2;
        if (myFile2 == undefined) {
          myFile = myFile3;
          if (myFile3 == undefined) {
            alert("Must select a MOF for analysis first.");
            thermal_pred_color = failure_red;
            $('#predict_t').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
            return;
          }
        }
      }

      // alert('You are about to begin a thermal stability prediction.')
      thermal_pred_color = inprogress_yellow;
      $('#predict_t').css({ 'background-color': inprogress_yellow, 'border-color': inprogress_yellow }); // setting button color to indicate in progress 
      $('#thermal_stability_prediction').text('The thermal stability prediction is loading...'); // display prediction result

      // getting the name of the selected MOF
      var name = document.getElementById('upload_status').innerHTML;
      name = name.split(' ');
      name = name.slice(-1)[0]; // getting the last element of the array

      // myFile.text() is a promise
      myFile.text().then(function (result) {
        // result is the text of the loaded .cif file

        myDict = { 'name': name, 'structure': result }

        $.post("/predict_thermal_stability", JSON.stringify(myDict)).done(
          function (response) {

            if (response == 'OVERLOAD') {
              alert('Server is receiving high traffic, please try again later')
              thermal_pred_color = failure_red;
              $('#predict_t').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
              $('#thermal_stability_prediction').text('')
              return; // Do not update thermal stability prediction if server is too busy.              
            }

            if (response == 'FAILED') {
              alert('Failed to featurize')
              thermal_pred_color = failure_red;
              $('#predict_t').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
              $('#thermal_stability_prediction').text('')
              return; // Do not update thermal stability prediction if prediction failed.
            }

            $('#thermal_form').show()
            $('#thermal_form input[name=cif_file_name]').val(myDict['name']);
            $('#thermal_form input[name=structure]').val(myDict['structure']); // Populate the feedback form with metadata
            thermal_pred_color = success_green;
            $('#predict_t').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success

            $('#neighbor_blurb').show() // show nearest neighbors section
            $('#thermal_neighbor_section').show()
            $('#descriptor_section').show() // show section where can download descriptors

            // There are two possibilities. Either a prediction is made, or the selected MOF is in the ANN's training data and so no prediction is made and instead the ground truth is returned.
            if (!response['in_train']) { // a prediction was made
              prediction = response['prediction'];
              $('#thermal_stability_prediction').text('The thermal stability prediction is: Thermal breakdown at ' + prediction); // display prediction result

              $.post("/thermal_stability_percentile", JSON.stringify(prediction)).done(function (response) {
                $('#thermal_stability_percentile').text('The percentile of thermal stability of the selected MOF with respect to the MOFs in the training data is: ' + response.toString());

                percentile_field = document.getElementById('thermal_stability_percentile');
                prediction_field = document.getElementById('thermal_stability_prediction');
                thermal_form = document.getElementById('thermal_form');
                if (response >= 80) {
                  response_color = '#90ee90' // color background, light green
                }
                else if (response >= 60) {
                  response_color = '#e7ff97' // light lime
                }
                else if (response >= 40) {
                  response_color = '#fffa97' // light yellow
                }
                else if (response >= 20) {
                  response_color = '#ffcd97' // light orange
                }
                else {
                  response_color = '#ffad97' // light red
                }
                setColor(percentile_field, response_color)
                setColor(prediction_field, response_color)
                setColor(thermal_form, response_color)
              })

              myDict = { 'prediction': true, 'temperature': prediction, 'temperature_data_type': 'string' }
              $.post("/plot_thermal_stability", JSON.stringify(myDict)).done(function (response) { // making the thermal breakdown temperatures plot
                $('#chart').html(response);
              })

              // Now that the prediction has been displayed, can move on to the neighbors display.
              var neighbor_names = response['neighbor_names']
              var neighbor_distances = response['neighbor_distances']

              // Converting these arrays into a dictionary called neighbors.
              var neighbors = {}
              for (i = 0; i < neighbor_names.length; i++) {
                neighbors[neighbor_names[i]] = neighbor_distances[i]
              }

              // Storing the information on the neighbors.
              document.getElementById('thermal_neighbors_holder').value = neighbors;

              // Populating the thermal neighbors dropdown.
              var thermal_dropdown = document.getElementById("thermal_neighbors");

              // clear dropdown
              var length = thermal_dropdown.options.length;
              for (i = length - 1; i >= 0; i--) {
                thermal_dropdown.options[i] = null;
              }

              // Populating the thermal neighbors dropdown.
              for (i = 0; i < neighbor_names.length; i++) {
                var option = document.createElement('option');
                var num = String(i + 1)
                num = num.concat('. ') // formatting to make it look like a list
                option.text = num.concat(neighbor_names[i]);
                thermal_dropdown.add(option);
              }

              // Setting text in the feedback form.
              $('#rate_thermal').text('Rate this prediction *')

            }

            else { // requested MOF was in the training data
              // Storing information indicating that a prediction was made, but no neighbors are available
              document.getElementById('thermal_neighbors_holder').value = 1

              $('#thermal_stability_prediction').text('This MOF is in the training data and is reported to have a thermal breakdown temperature of ' + response['truth']);

              $.post("/thermal_stability_percentile", JSON.stringify(response['truth'])).done(function (response) {
                $('#thermal_stability_percentile').text('The percentile of thermal stability of the selected MOF with respect to the MOFs in the training data is: ' + response.toString());

                percentile_field = document.getElementById('thermal_stability_percentile');
                prediction_field = document.getElementById('thermal_stability_prediction');
                thermal_form = document.getElementById('thermal_form');
                if (response >= 80) {
                  response_color = '#90ee90' // color background, light green
                }
                else if (response >= 60) {
                  response_color = '#e7ff97' // light lime
                }
                else if (response >= 40) {
                  response_color = '#fffa97' // light yellow
                }
                else if (response >= 20) {
                  response_color = '#ffcd97' // light orange
                }
                else {
                  response_color = '#ffad97' // light red
                }
                setColor(percentile_field, response_color)
                setColor(prediction_field, response_color)
                setColor(thermal_form, response_color)

              })

              myDict = { 'prediction': false, 'temperature': response['truth'], 'temperature_data_type': 'string' }
              $.post("/plot_thermal_stability", JSON.stringify(myDict)).done(function (response) { // making the thermal breakdown temperatures plot
                $('#chart').html(response);
              })

              // Setting text in the feedback form.
              $('#rate_thermal').text('Rate this ground truth *')
            }
          })
          .fail(function(xhr, textStatus, errorThrown) { // for timeout error; triggers after 1 minute
            thermal_pred_color = failure_red;
            $('#predict_t').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
            $('#thermal_stability_prediction').text('')
            alert(errorThrown.concat("; MOF may be too large for web-based analysis")) // errorThrown will likely look like "Gateway Time-out"
          })
        })
});


    // Generate MOF from building blocks when the "Make bb-generated MOF" button is clicked.
    $('#generate').click(function () {
      renew('bb');

      my_linker = $('#linker_option').val() // Check which linker is selected in the linker building block construction dropdown.
      my_sbu = $('#sbu_option').val() // Check which sbu is selected in the sbu building block construction dropdown.
      my_net = $('#nets_option').val() // Check which net is selected in the net building block dropdown.

      if (my_linker === '') {
        alert("Must choose a linker building block first.");
        return;
      }
      else if (my_sbu === '') {
        alert("Must choose a sbu building block first.");
        return;
      }
      else if (my_net === '') {
        alert("Must choose a net first.");
        return;
      }

      bb_information = {}; // a dictionary
      bb_information.linker = my_linker;
      bb_information.sbu = my_sbu;
      bb_information.net = my_net;

      $.post("/get_bb_generated_MOF", JSON.stringify(bb_information)).done(
        function (response) {

          if (response == 'FAILED') {
            alert('Failed to generate MOF')
            bb_redirect_color = failure_red;
            $('#bb-redirect').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
            document.getElementById('bbg_MOF_holder').value = undefined; // clearing the value
            return;
          }

          var result = JSON.parse(response);

          var name = result.mof_name;

          // The function corresponding to @app.route('/get_bb_generated_MOF', methods=['POST']) on the backend will make a cif file of the building block generated MOF if successful, using ToBaCCo 3.0 code. Files are made in the temp_file_creation/tobacco_3.0/output_cifs folder.

          // grab user ID, then feed that into the fetch operation
          // fetch was having issues with the ID key of session on the backend, so this is a workaround
          $.get("/get_ID").done(
            function (response) {
              my_ID = response

              fetch('bbcif/primitive_' + name + '~' + my_ID).then(response => { // grabbing the MOF from local host
                if (!response.ok) { // catching 404 and other issues
                  document.getElementById('bbg_MOF_holder').value = undefined; // clearing the value
                  throw Error(response.statusText);
                }
                return response.blob();
              }).then(function (blob) {
                var myFile = new File([blob], "example.cif", { type: "", lastModified: Date.now() }) // making a cif file
                document.getElementById('bbg_MOF_holder').value = myFile; //bbMOF

                $('#upload_status').text('Selected MOF (assembled): ' + name);
                bb_redirect_color = success_green;
                $('#bb-redirect').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success
                $('#pills-main-tab').click() // redirecting to appropriate tab
                $('#predict_section').show() // show the prediction button section
                $('#status_section').show() // show the status section
              }).catch(error => {
                $('#upload_status').text('Failed to load');
                console.error('There has been a problem with your fetch operation:', error);
              })
            })

        });
    });

    // Triggers when the "Download bb-generated MOF" button is clicked.
    $('#download_generated').click(function () {
      if (document.getElementById('bbg_MOF_holder').value == undefined) {
        alert('Must generate MOF with building blocks first, using Make bb-generated MOF button.');
        return;
      }

      var myFile = document.getElementById('bbg_MOF_holder').value;
      name = get_selected_MOF();

      $.get("/get_ID").done(
        function (response) {
          my_ID = response
          window.location = '/bbcif/' + name + '~' + my_ID // get file from the temp_file_creation_USERID/tobacco_3.0/output_cifs folder
          // assuming primitive is same as normal file   
        })
    })


    // Load an example MOF when the "Select example MOF "
    $('#select_example').click(function () {
      my_MOF = $('#MOF_option').val() // Check which MOF is selected in the Example MOF options dropdown.

      if (my_MOF === '') {
        alert("Must choose a MOF first.");
        return;
      }

      if (my_MOF === 'HKUST-1 (default)') {
        default_loader()
      }
      else { // have a CSD MOF
        csd_loader(my_MOF)
      }
      $('#pills-main-tab').click() // redirecting to appropriate tab
    })

    function default_loader() {
      fetch('mof_examples/HKUST1.cif').then(response => { // grabbing the example MOF from local host
        if (!response.ok) { // catching 404 and other issues
          load_color = failure_red;
          $('#example-redirect').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
          throw Error(response.statusText);
        }
        return response.blob();
      }).then(function (blob) {
        renew('example'); // note: I call renew here rather than at the beginning of the load function in order to prevent NGL.Stage from throwing a hissy fit
        var myFile = new File([blob], "example.cif", { type: "", lastModified: Date.now() }) // making a cif file
        document.getElementById('example_holder').value = myFile; // setting the value of example_holder
        $('#upload_status').text('Selected MOF: HKUST-1'); // indicating that the example MOF has been uploaded
        load_color = success_green;
        $('#example-redirect').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success
        $('#predict_section').show() // show the prediction button section
        $('#status_section').show() // show the status section

        alert('Example MOF loaded!')
      }).catch(error => {
        renew('example'); 
        load_color = failure_red;
        $('#example-redirect').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
        $('#upload_status').text('Failed to upload example MOF');
        console.error('There has been a problem with your fetch operation:', error);
      })
    };

    function csd_loader(my_MOF) {
      // my_MOF is the six letter refcode, plus stuff like _clean

      fetch('CoRE2019/' + my_MOF + '.cif').then(response => { // grabbing the example MOF from local host
        if (!response.ok) { // catching 404 and other issues
          load_color = failure_red;
          $('#example-redirect').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
          throw Error(response.statusText);
        }
        return response.blob();
      }).then(function (blob) {
        renew('example'); // note: I call renew here rather than at the beginning of the load function in order to prevent NGL.Stage from throwing a hissy fit
        var myFile = new File([blob], "example.cif", { type: "", lastModified: Date.now() }) // making a cif file
        document.getElementById('example_holder').value = myFile; // setting the value of example_holder
        $('#upload_status').text('Selected MOF: ' + my_MOF); // indicating that the example MOF has been uploaded
        load_color = success_green;
        $('#example-redirect').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success
        $('#predict_section').show() // show the prediction button section
        $('#status_section').show() // show the status section

        alert('Example MOF loaded!')
      }).catch(error => {
        renew('example');
        load_color = failure_red;
        $('#example-redirect').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
        $('#upload_status').text('Failed to upload example MOF');
        console.error('There has been a problem with your fetch operation:', error);
      })

    }


    // Get MOF linkers and sbus when the "Get selected (1) MOF components" button is clicked.
    // Returns a dictionary of linkers and sbus, also includes information about number of linkers and sbus
    $('#get_components').click(function () {

      // Clearing things
      document.getElementById('toggle_unique_components').textContent = 'Filter by connectivity'; // reset the uniqueness-filter button
      $('#component_SMILES').text('') // clear the SMILES text
      $('#resize_hint').hide()
      component_viewer.clear(); // clear component visualizer
      $('#comp_MOF').text('') // clear the text about which MOF is broken into components
      clear_component_dropdowns();

      // check if a cif is uploaded
      let myFile = document.getElementById('file_input').files[0]; // the uploaded file
      let myFile2 = document.getElementById('example_holder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbg_MOF_holder').value; // the generated MOF, if Make bb-generated MOF has been used

      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile == undefined) {
        myFile = myFile2;
        if (myFile2 == undefined) {
          myFile = myFile3;
          if (myFile3 == undefined) {
            alert("Must select a MOF for analysis first.");
            component_color = failure_red;
            $('#get_components').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
            return;
          }
        }
      }

      component_color = inprogress_yellow;
      $('#get_components').css({ 'background-color': inprogress_yellow, 'border-color': inprogress_yellow }); // setting button color to indicate in progress

      name = get_selected_MOF();

      // myFile.text() is a promise
      myFile.text().then(function (result) {

        myDict = { 'name': name, 'structure': result }

        // result is the text of the loaded .cif file
        $.post("/get_components", JSON.stringify(myDict)).done(
          function (response) {

            if (response == 'OVERLOAD') {
              alert('Server is receiving high traffic, please try again later')
              document.getElementById('components_holder').value = undefined; // clearing the value, so no component visualization is possible
              component_color = failure_red;
              $('#get_components').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
              return;             
            }

            if (response == 'FAILED') {
              alert('Failed to featurize.')
              document.getElementById('components_holder').value = undefined; // clearing the value, so no component visualization is possible
              component_color = failure_red;
              $('#get_components').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
              return;
            }

            component_color = success_green;
            $('#get_components').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success

            var result = JSON.parse(response);

            var linker_dropdown = document.getElementById('linker');
            var sbu_dropdown = document.getElementById('sbu');

            num_linkers = result.total_linkers;
            num_sbus = result.total_sbus;

            // Populating the linker dropdown.
            for (i = 1; i <= num_linkers; i++) {
              var option = document.createElement('option');
              option.text = 'Linker ' + i.toString();
              linker_dropdown.add(option);
            }

            // Populating the sbu dropdown.
            for (i = 1; i <= num_sbus; i++) {
              var option = document.createElement('option');
              option.text = 'SBU ' + i.toString();
              sbu_dropdown.add(option);
            }

            // Storing the linker and sbu data.
            document.getElementById('components_holder').value = result;

            $('#comp_MOF').text('MOF for which components are listed below: ' + name)

          })
          .fail(function(xhr, textStatus, errorThrown) { // for timeout error; triggers after 1 minute
            document.getElementById('components_holder').value = undefined; // clearing the value, so no component visualization is possible
            component_color = failure_red;
            $('#get_components').css({ 'background-color': failure_red, 'border-color': failure_red }); // setting button color to indicate failure
            alert(errorThrown.concat("; MOF may be too large for web-based analysis"))
          })
        })
    });


    // Get solvent removal stability latent space nearest neighbor MOF linkers and sbus when the "Get components" button in the solvent section is clicked.
    // Returns a dictionary of linkers and sbus, also includes information about number of linkers and sbus
    $('#comp_s_neighbor').click(function () {

      component_color = original_blue;
      $('#get_components').css({ 'background-color': original_blue, 'border-color': original_blue }); // setting button color

      // Clearing things
      document.getElementById('toggle_unique_components').textContent = 'Filter by connectivity'; // reset the uniqueness-filter button
      $('#component_SMILES').text('') // clear the SMILES text
      $('#resize_hint').hide() // hide the hint on resizing the window if no component appears
      component_viewer.clear(); // clear component visualizer
      $('#comp_MOF').text('') // clear the text about which MOF is broken into components
      clear_component_dropdowns();

      // Ensure there are neighbors to display information on
      if (document.getElementById('solvent_neighbors_holder').value == undefined) {
        alert('Must make solvent removal stability prediction first.');
        return;
      }

      if (document.getElementById('solvent_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      $('#pills-comp-tab').click() // redirecting to appropriate tab

      my_neighbor = $('#solvent_neighbors').val(); // select the solvent removal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      fetch('CoRE2019/' + my_neighbor + '.cif').then(response => { // grabbing the MOF from local host
        if (!response.ok) { // catching 404 and other issues
          throw Error(response.statusText);
        }
        return response.blob();
      }).then(function (blob) {
        var myFile = new File([blob], "solvent_neighbor.cif", { type: "", lastModified: Date.now() }) // making a cif file

        // next, do the component breakdown

        // myFile.text() is a promise
        myFile.text().then(function (result) {
          // result is the text of the loaded .cif file

          myDict = { 'name': my_neighbor, 'structure': result }

          $.post("/get_components", JSON.stringify(myDict)).done(
            function (response) {

              if (response == 'FAILED') {
                alert('Failed to featurize.')
                document.getElementById('components_holder').value = undefined; // clearing the value, so no component visualization is possible
                return;
              }

              var result = JSON.parse(response);

              var linker_dropdown = document.getElementById('linker');
              var sbu_dropdown = document.getElementById('sbu');

              num_linkers = result.total_linkers;
              num_sbus = result.total_sbus;

              // Populating the linker dropdown.
              for (i = 1; i <= num_linkers; i++) {
                var option = document.createElement('option');
                option.text = 'Linker ' + i.toString();
                linker_dropdown.add(option);
              }

              // Populating the sbu dropdown.
              for (i = 1; i <= num_sbus; i++) {
                var option = document.createElement('option');
                option.text = 'SBU ' + i.toString();
                sbu_dropdown.add(option);
              }

              // Storing the linker and sbu data.
              document.getElementById('components_holder').value = result;

              $('#comp_MOF').text('MOF for which components are listed below: ' + my_neighbor)

            });
        })

      }).catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
      })

    });

    // Get thermal stability latent space nearest neighbor MOF linkers and sbus when the "Get components" button in the thermal section is clicked.
    // Returns a dictionary of linkers and sbus, also includes information about number of linkers and sbus
    $('#comp_t_neighbor').click(function () {

      component_color = original_blue;
      $('#get_components').css({ 'background-color': original_blue, 'border-color': original_blue }); // setting button color

      // Clearing things
      document.getElementById('toggle_unique_components').textContent = 'Filter by connectivity'; // reset the uniqueness-filter button
      $('#component_SMILES').text('') // clear the SMILES text
      $('#resize_hint').hide()
      component_viewer.clear(); // clear component visualizer
      $('#comp_MOF').text('') // clear the text about which MOF is broken into components
      clear_component_dropdowns();

      // Ensure there are neighbors to display information on
      if (document.getElementById('thermal_neighbors_holder').value == undefined) {
        alert('Must make thermal stability prediction first.');
        return;
      }

      if (document.getElementById('thermal_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      $('#pills-comp-tab').click() // redirecting to appropriate tab

      my_neighbor = $('#thermal_neighbors').val(); // select the thermal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      fetch('CoRE2019/' + my_neighbor + '.cif').then(response => { // grabbing the MOF from local host
        if (!response.ok) { // catching 404 and other issues
          throw Error(response.statusText);
        }
        return response.blob();
      }).then(function (blob) {
        var myFile = new File([blob], "thermal_neighbor.cif", { type: "", lastModified: Date.now() }) // making a cif file

        // next, do the component breakdown

        // myFile.text() is a promise
        myFile.text().then(function (result) {
          // result is the text of the loaded .cif file

          myDict = { 'name': my_neighbor, 'structure': result }

          $.post("/get_components", JSON.stringify(myDict)).done(
            function (response) {

              if (response == 'FAILED') {
                alert('Failed to featurize.')
                document.getElementById('components_holder').value = undefined; // clearing the value, so no component visualization is possible
                return;
              }

              var result = JSON.parse(response);

              var linker_dropdown = document.getElementById('linker');
              var sbu_dropdown = document.getElementById('sbu');

              num_linkers = result.total_linkers;
              num_sbus = result.total_sbus;

              // Populating the linker dropdown.
              for (i = 1; i <= num_linkers; i++) {
                var option = document.createElement('option');
                option.text = 'Linker ' + i.toString();
                linker_dropdown.add(option);
              }

              // Populating the sbu dropdown.
              for (i = 1; i <= num_sbus; i++) {
                var option = document.createElement('option');
                option.text = 'SBU ' + i.toString();
                sbu_dropdown.add(option);
              }

              // Storing the linker and sbu data.
              document.getElementById('components_holder').value = result;

              $('#comp_MOF').text('MOF for which components are listed below: ' + my_neighbor)

            });
        })

      }).catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
      })

    });


    // This function is used to clear dropdowns
    function clear_component_dropdowns() { 
      // Clearing the linker dropdown.
      var linker_dropdown = document.getElementById('linker');
      var length = linker_dropdown.options.length;
      for (i = length - 1; i >= 0; i--) {
        linker_dropdown.options[i] = null;
      }

      // Clearing the sbu dropdown.
      var sbu_dropdown = document.getElementById('sbu');
      var length = sbu_dropdown.options.length;
      for (i = length - 1; i >= 0; i--) {
        sbu_dropdown.options[i] = null;
      }
    }

    // Triggers when the "Filter by connectivity" button (or the "No filter" button) is clicked.
    $('#toggle_unique_components').click(function () {

      // Ensure there are components to visualize
      if (document.getElementById('components_holder').value == undefined) {
        alert('Must get a MOF\'s components first.');
        return;
      }

      clear_component_dropdowns();

      // Find the dropdowns.
      var linker_dropdown = document.getElementById('linker');
      var sbu_dropdown = document.getElementById('sbu');

      // Two different cases, depending if we are toggling unique components on or off
      if (document.getElementById('toggle_unique_components').textContent == 'Filter by connectivity') { // Want only unique components.
        document.getElementById('toggle_unique_components').textContent = 'No filter'; // cycle the button text on click

        // Getting the unique indices (used to determine which linkers/sbus are unique).
        unique_linker_indices = document.getElementById('components_holder').value.unique_linker_indices;
        unique_sbu_indices = document.getElementById('components_holder').value.unique_sbu_indices;

        // Populating the linker dropdown.
        for (i in unique_linker_indices) {
          j = parseInt(i) + 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index
          var option = document.createElement('option');
          option.text = 'Linker ' + j.toString();
          linker_dropdown.add(option);
        }

        // Populating the sbu dropdown.
        for (i in unique_sbu_indices) {
          j = parseInt(i) + 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index
          var option = document.createElement('option');
          option.text = 'SBU ' + j.toString();
          sbu_dropdown.add(option);
        }

      }
      else if (document.getElementById('toggle_unique_components').textContent == 'No filter') { // Want No filter.
        document.getElementById('toggle_unique_components').textContent = 'Filter by connectivity'; // cycle the button text on click

        // Getting the total number of linkers and sbus.
        num_linkers = document.getElementById('components_holder').value.total_linkers;
        num_sbus = document.getElementById('components_holder').value.total_sbus;

        // Populating the linker dropdown.
        for (i = 1; i <= num_linkers; i++) {
          var option = document.createElement('option');
          option.text = 'Linker ' + i.toString();
          linker_dropdown.add(option);
        }

        // Populating the sbu dropdown.
        for (i = 1; i <= num_sbus; i++) {
          var option = document.createElement('option');
          option.text = 'SBU ' + i.toString();
          sbu_dropdown.add(option);
        }
      }
    })


    // Visualize the linker after MOF components have been resolved when the "Linker" button is clicked.
    $('#visualize_linker').click(function () {

      // Ensure there are components to visualize.
      if (document.getElementById('components_holder').value == undefined) {
        alert('Must get a MOF\'s components first.');
        return;
      }

      my_linker = $('#linker').val() // Check which linker is selected in the linker dropdown 
      linker_number = my_linker.split(" "); // an array, split at the space
      linker_number = parseInt(linker_number[1]); // gets the number
      linker_number = linker_number - 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index

      // Getting xyz data.
      dictionary = document.getElementById('components_holder').value;
      my_key = 'linker_' + linker_number;

      geometry = dictionary[my_key];

      $('#container-01-note').text('');
      component_viewer.clear();
      component_viewer.addModel(geometry, "xyz");
      component_viewer.setStyle({}, { stick: { radius: 0.25 } });
      component_viewer.zoomTo();
      component_viewer.render();

      // Showing the SMILES string.
      $('#component_SMILES').text('The currently visualized linker\'s SMILES string is ' + dictionary[my_key + '_SMILES'])

      $('#resize_hint').show() // show the hint to resize browser if component not showing up
    })


    // Visualize the sbu after MOF components have been resolved when the "SBU" button is clicked.
    $('#visualize_sbu').click(function () {

      // Ensure there are components to visualize.
      if (document.getElementById('components_holder').value == undefined) {
        alert('Must get a MOF\'s components first.');
        return;
      }

      my_sbu = $('#sbu').val() // Check which sbu is selected in the linker dropdown 
      sbu_number = my_sbu.split(" "); // an array, split at the space
      sbu_number = parseInt(sbu_number[1]); // gets the number
      sbu_number = sbu_number - 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index

      // Getting xyz data.
      dictionary = document.getElementById('components_holder').value;
      my_key = 'sbu_' + sbu_number;

      geometry = dictionary[my_key];

      $('#container-01-note').text('');
      component_viewer.clear();
      component_viewer.addModel(geometry, "xyz");
      component_viewer.setStyle({}, { stick: { radius: 0.25 } });
      component_viewer.zoomTo();
      component_viewer.render();

      // Showing the SMILES string.
      $('#component_SMILES').text('The currently visualized SBU\'s SMILES string is ' + dictionary[my_key + '_SMILES']);

      $('#resize_hint').show() // show the hint to resize browser if component not showing up
    })

    function clear_neighbor_dropdowns() { // clear dropdowns when upload new file
      // Clearing solvent removal stability ANN nearest neighbors dropdown.
      var solvent_dropdown = document.getElementById("solvent_neighbors");
      var length = solvent_dropdown.options.length;
      for (i = length - 1; i >= 0; i--) {
        solvent_dropdown.options[i] = null;
      }

      // Clearing thermal stability ANN nearest neighbors dropdown.
      var thermal_dropdown = document.getElementById("thermal_neighbors");
      var length = thermal_dropdown.options.length;
      for (i = length - 1; i >= 0; i--) {
        thermal_dropdown.options[i] = null;
      }
    }

    // Get information on a nearest neighbor in solvent removal stability ANN latent space when the "Show" button in the solvent section is clicked.
    $('#s_neighbor').click(function () {

      // Ensure there are neighbors to display information on
      if (document.getElementById('solvent_neighbors_holder').value == undefined) {
        alert('Must make solvent removal stability prediction first.');
        return;
      }

      if (document.getElementById('solvent_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      my_neighbor = $('#solvent_neighbors').val(); // select the solvent removal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      // Get the latent space distance from the information returned from the prediction.
      dictionary = document.getElementById('solvent_neighbors_holder').value;
      latent_distance = dictionary[my_neighbor];

      if (latent_distance.charAt(0) == '.') { // If the latent distance starts with a decimal, add a zero in front of it
        latent_distance = '0' + latent_distance;
      }

      // Grab the solvent removal stability flag and DOI from the appropriate Excel sheet with a POST request.
      $.post("/solvent_neighbor_flag", JSON.stringify(my_neighbor)).done(
        function (response) {
          flag = response['flag']
          if (flag == 1) {
            document.getElementById('s_neighbor_info').innerHTML = 'Current nearest neighbor: '
            + my_neighbor + ' <br />Current nearest neighbor\'s latent distance: ' + latent_distance
              + '<br />Nearest neighbor DOI: ' + response['doi'] + '<br />Experimentally observed to be stable upon solvent removal? Yes' // <br /> for a new line in display
            }
            else {
              document.getElementById('s_neighbor_info').innerHTML = 'Current nearest neighbor: '
              + my_neighbor + ' <br />Current nearest neighbor\'s latent distance: ' + latent_distance
              + '<br />Nearest neighbor DOI: ' + response['doi'] + '<br />Experimentally observed to be stable upon solvent removal? No' // <br /> for a new line in display
            }
            $('#solvent_neighbor_form').show()
            $('#solvent_neighbor_form input[name=cif_file_name]').val(my_neighbor);
            $('#solvent_neighbor_form input[name=structure]').val('');
          })
    })


    // Download the cif file of the nearest neighbor in solvent removal stability ANN latent space when the "Download" button in the solvent section is clicked. 
    // Also download a .txt file that contains information on the nearest neighbor.
    $('#download_s_neighbor').click(function () {

      // Ensure there are neighbors to display information on
      if (document.getElementById('solvent_neighbors_holder').value == undefined) {
        alert('Must make solvent removal stability prediction first.');
        return;
      }

      if (document.getElementById('solvent_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      my_neighbor = $('#solvent_neighbors').val(); // select the solvent removal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      // Making the txt file with information about the neighbor
      // The txt file will contain the following information: prediction type, current MOF, selected CoRE nearest neighbor, latent space distance, and property for nearest neighbor
      var dict = {}
      dict['prediction_type'] = 'solvent'

      name = get_selected_MOF(false);

      dict['current_MOF'] = name
      dict['selected_neighbor'] = my_neighbor

      // Get the latent space distance from the information returned from the prediction.
      dictionary = document.getElementById('solvent_neighbors_holder').value;
      latent_distance = dictionary[my_neighbor];

      if (latent_distance.charAt(0) == '.') { // If the latent distance starts with a decimal, add a zero in front of it
        latent_distance = '0' + latent_distance;
      }

      dict['latent_space_distance'] = latent_distance

      $.post("/neighbor_writer", JSON.stringify(dict)).done(
        function (response) {
          download(response['file_name'], response['contents']);
        })

      setTimeout(function () {
        window.location = '/CoRE2019/' + my_neighbor + '.cif'; // download cif file from the CoRE2019 folder
      }, 1000); // the delay is to make it possible to download multiple files in the same function

    })

    // Get information on a nearest neighbor in thermal stability ANN latent space when the "Show" button in the thermal section is clicked.
    $('#t_neighbor').click(function () {

      // Ensure there are neighbors to display information on.
      if (document.getElementById('thermal_neighbors_holder').value == undefined) {
        alert('Must make thermal stability prediction first.');
        return;
      }

      if (document.getElementById('thermal_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      my_neighbor = $('#thermal_neighbors').val(); // select the thermal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      // Get the latent space distance from the information returned from the prediction.
      dictionary = document.getElementById('thermal_neighbors_holder').value;
      latent_distance = dictionary[my_neighbor];

      if (latent_distance.charAt(0) == '.') { // If the latent distance starts with a decimal, add a zero in front of it
        latent_distance = '0' + latent_distance;
      }

      // Grab the thermal breakdown temperature from the appropriate Excel sheet with a POST request.
      $.post("/thermal_neighbor_T", JSON.stringify(my_neighbor)).done(
        function (response) {
          document.getElementById('t_neighbor_info').innerHTML = 'Current nearest neighbor: '
          + my_neighbor + ' <br />Current nearest neighbor\'s latent distance: ' + latent_distance
          + '<br />Circle in TGA plot marks the breakdown temperature.<br />Nearest neighbor DOI: '
            + response['doi'] // <br /> for a new line in display. &#8451 is degrees Celsius in decimal
            + '<br />Experimentally observed thermal breakdown temperature: ' + response['T']
            + '&#8451';
            $('#thermal_neighbor_form').show()
            $('#thermal_neighbor_form input[name=cif_file_name]').val(my_neighbor);
          $('#thermal_neighbor_form input[name=structure]').val(''); // Populate the feedback form with metadata
        })

      $.post("/TGA_plot", JSON.stringify(my_neighbor)).done(function (response) {
        $('#tga_plot').html(response) // a simplified TGA plot (the two slopes, intersecting at breakdown temperature)
      })

      $('#tga_explanation').show() // show the explanatory TGA graphic on simplified TGA plots


    })


    // Download the cif file of the nearest neighbor in thermal stability ANN latent space when the "Download" button in the thermal section is clicked. 
    // Also download a .txt file that contains information on the nearest neighbor.
    // Also download a .csv file with the TGA data for the MOF.
    $('#download_t_neighbor').click(function () {

      // Ensure there are neighbors to display information on
      if (document.getElementById('thermal_neighbors_holder').value == undefined) {
        alert('Must make thermal stability prediction first.');
        return;
      }

      if (document.getElementById('thermal_neighbors_holder').value == 1) {
        alert('The current MOF was in the training data, where the ground truth is known. The ground truth was returned without neighbors.');
        return;
      }

      my_neighbor = $('#thermal_neighbors').val(); // select the thermal stability ANN nearest neighbor selected in the dropdown
      my_neighbor = my_neighbor.substring(3) // hack off the list-y number part

      // Making the txt file with information about the neighbor
      // The txt file will contain the following information: prediction type, current MOF, selected CoRE nearest neighbor, latent space distance, and property for nearest neighbor
      var dict = {}
      dict['prediction_type'] = 'thermal'

      name = get_selected_MOF(false);

      dict['current_MOF'] = name
      dict['selected_neighbor'] = my_neighbor

      // Get the latent space distance from the information returned from the prediction.
      dictionary = document.getElementById('thermal_neighbors_holder').value;
      latent_distance = dictionary[my_neighbor];

      if (latent_distance.charAt(0) == '.') { // If the latent distance starts with a decimal, add a zero in front of it
        latent_distance = '0' + latent_distance;
      }

      dict['latent_space_distance'] = latent_distance

      $.post("/neighbor_writer", JSON.stringify(dict)).done(
        function (response) {
          download(response['file_name'], response['contents']);
        })

      setTimeout(function () {
        window.location = '/CoRE2019/' + my_neighbor + '.cif'; // download cif file from the CoRE2019 folder
      }, 1000); // the delay is to make it possible to download multiple files in the same function

      setTimeout(function () {
        // Download csv file with TGA data

        // Grab the contents of the descriptor csv
        $.post("/get_TGA", JSON.stringify(my_neighbor)).done(
          function (response) {
            download(my_neighbor + '_TGA.csv', response)
          })

      }, 2000); // the delay is to make it possible to download multiple files in the same function

    })


    // This function is used for downloading information on nearest neighbors and xyz's of components
    // filename is the name of the file to be downloaded. text is the contents of the file.
    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

    // Two functions to deal with requests to download a selected component's xyz file
    $('#download_linker').click(function () {
      download_component('Linker')
    })

    $('#download_sbu').click(function () {
      download_component('SBU')
    })

    // This function is called when "Download linker" or "Download SBU" are clicked
    // Input will either be 'Linker' or 'SBU'
    // Downloads an xyz file
    function download_component(component) {
      // Get the currently selected component from the appropriate dropdown menu

      // Ensure there are components to visualize.
      if (document.getElementById('components_holder').value == undefined) {
        alert('Must get a MOF\'s components first.');
        return;
      }

      var name = document.getElementById('comp_MOF').innerHTML; // getting the name of the MOF for which components are being visualized
      name = name.split(': ');
      name = name.slice(-1)[0]; // getting the last element of the array
      if (name.substring(name.length - 4) == '.cif') { // getting rid of the .cif part
        name = name.substring(0, name.length - 4)
      }

      // I do this instead of redirecting to the xyz file (which would be simpler) in order to specify the name of the downloaded xyz file, make it more informative
      if (component == 'Linker') {
        my_linker = $('#linker').val() // Check which linker is selected in the linker dropdown 
        linker_number = my_linker.split(" "); // an array, split at the space
        linker_number = parseInt(linker_number[1]); // gets the number

        // Getting xyz data.
        dictionary = document.getElementById('components_holder').value;
        my_key = 'linker_' + linker_number;

        geometry = dictionary[my_key];

        download(name + '-' + my_key + '.xyz', geometry)
      }
      else {
        my_sbu = $('#sbu').val() // Check which sbu is selected in the linker dropdown 
        sbu_number = my_sbu.split(" "); // an array, split at the space
        sbu_number = parseInt(sbu_number[1]); // gets the number

        // Getting xyz data.
        dictionary = document.getElementById('components_holder').value;
        my_key = 'sbu_' + sbu_number;

        geometry = dictionary[my_key];
        download(name + '-' + my_key + '.xyz', geometry)
      }
    }


    // When the "Download descriptors" button is clicked, download the descriptors for the selected MOF
    $('#download_descriptors').click(function () {
      name = get_selected_MOF(false) // don't want the .cif extension

      // Grab the contents of the descriptor csv
      $.post("/get_descriptors", JSON.stringify(name)).done(
        function (response) {
          descriptor_color = success_green;
          $('#download_descriptors').css({ 'background-color': success_green, 'border-color': success_green }); // setting button color to indicate success
          download(name + '_descriptors.csv', response)
        })

    })


    // Form check for file extensions
    upload_extensions = ['pdf', 'jpg', 'png', 'tiff'] // ['jpg', 'jpeg', 'png', 'pdf', 'tiff', 'tif', 'eps'] // acceptable file types

    // The next few functions handle form submission. Specifically, the printing of messages to indicate if form submission went through.

    // When the "Submit" button is clicked for the solvent removal stability prediction/ground truth feedback
    $('#submit_A').click(function () {
      // Returns an alert to the user indicating whether their feedback was accepted. Sends form data to backend if form is filled out well.

      // First, ensures that the required fields are filled out. If not, returns, and no alerts are shown.
      var rating = document.getElementById('solvent_rating').value;      
      var email = document.getElementById('solvent_rating_email').value;
      var reason = document.getElementById('inputState_A').value;

      success = true // Tracks whether the form should be sent to the backend

      if (rating && email && reason) { // requisite fields have been filled out
        var file = document.getElementById('validatedCustomFile_A').value;

        if (file) { // The user did upload the optional TGA file.
          my_name = file.split(/(\\|\/)/g).pop() // split the string ({filepath}/{filename}) and get the file name
          my_extension = getExtension(my_name);
          if (upload_extensions.includes(my_extension.toLowerCase())) {
            alert('Thank you for your feedback!')
          }
          else {
            alert('Invalid file extension.')
            success = false
          }  
        }
        else { // The user did not upload the optional TGA file
          alert('Thank you for your feedback!')
        }

        var data = new FormData($('#solvent_stability_feedback')[0])
        document.getElementById('solvent_stability_feedback').reset() // reset the form
        if (success) { // send form data to backend
          var request = new XMLHttpRequest();
          request.onreadystatechange = function() { return; } // Override the response behavior of the request
          request.open("POST", 'process_feedback', true)
          request.send(data)
        }
        
        $("#TGA_A").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text
      }
    })

    // When the "Submit" button is clicked for the thermal stability prediction/ground truth feedback
    $('#submit_B').click(function () {
      // Returns an alert to the user indicating whether their feedback was accepted. Sends form data to backend if form is filled out well.

      // First, ensures that the required fields are filled out. If not, returns, and no alerts are shown.
      var rating = document.getElementById('thermal_rating').value;      
      var email = document.getElementById('thermal_rating_email').value;
      var reason = document.getElementById('inputState_B').value;

      success = true // Tracks whether the form should be sent to the backend

      if (rating && email && reason) { // requisite fields have been filled out
        var file = document.getElementById('validatedCustomFile_B').value;

        if (file) { // The user did upload the optional TGA file.
          my_name = file.split(/(\\|\/)/g).pop() // split the string ({filepath}/{filename}) and get the file name
          my_extension = getExtension(my_name);
          if (upload_extensions.includes(my_extension.toLowerCase())) {
            alert('Thank you for your feedback!')
          }
          else {
            alert('Invalid file extension.')
            success = false;
          }  
        }
        else { // The user did not upload the optional TGA file
          alert('Thank you for your feedback!')
        }

        var data = new FormData($('#thermal_stability_feedback')[0])
        document.getElementById('thermal_stability_feedback').reset() // reset the form
        if (success) { // send form data to backend
          var request = new XMLHttpRequest();
          request.onreadystatechange = function() { return; } // Override the response behavior of the request
          request.open("POST", 'process_feedback', true)
          request.send(data)
        }

        $("#TGA_B").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text
      }
    })

    // When the "Submit" button is clicked for the solvent neighbor feedback
    $('#submit_C').click(function () {
      // Returns an alert to the user indicating whether their feedback was accepted. Sends form data to backend if form is filled out well.

      // First, ensures that the required fields are filled out. If not, returns, and no alerts are shown.
      var rating = document.getElementById('solvent_neighbor_rating').value;      
      var email = document.getElementById('solvent_neighbor_rating_email').value;
      var reason = document.getElementById('inputState_C').value;

      success = true // Tracks whether the form should be sent to the backend

      if (rating && email && reason) { // requisite fields have been filled out
        var file = document.getElementById('validatedCustomFile_C').value;

        if (file) { // The user did upload the optional TGA file.
          my_name = file.split(/(\\|\/)/g).pop() // split the string ({filepath}/{filename}) and get the file name
          my_extension = getExtension(my_name);
          if (upload_extensions.includes(my_extension.toLowerCase())) {
            alert('Thank you for your feedback!')
          }
          else {
            alert('Invalid file extension.')
            success = false
          }  
        }
        else { // The user did not upload the optional TGA file
          alert('Thank you for your feedback!')
        }

        var data = new FormData($('#solvent_stability_neighbor_feedback')[0])
        document.getElementById('solvent_stability_neighbor_feedback').reset() // reset the form
        if (success) { // send form data to backend
          var request = new XMLHttpRequest();
          request.onreadystatechange = function() { return; } // Override the response behavior of the request
          request.open("POST", 'process_feedback', true)
          request.send(data)
        }

        $("#TGA_C").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text
      }
    })

    // When the "Submit" button is clicked for the thermal neighbor feedback
    $('#submit_D').click(function () {
      // Returns an alert to the user indicating whether their feedback was accepted. Sends form data to backend if form is filled out well.

      // First, ensures that the required fields are filled out. If not, returns, and no alerts are shown.
      var rating = document.getElementById('thermal_neighbor_rating').value;      
      var email = document.getElementById('thermal_neighbor_rating_email').value;
      var reason = document.getElementById('inputState_D').value;

      success = true // Tracks whether the form should be sent to the backend

      if (rating && email && reason) { // requisite fields have been filled out
        var file = document.getElementById('validatedCustomFile_D').value;

        if (file) { // The user did upload the optional TGA file.
          my_name = file.split(/(\\|\/)/g).pop() // split the string ({filepath}/{filename}) and get the file name
          my_extension = getExtension(my_name);
          if (upload_extensions.includes(my_extension.toLowerCase())) {
            alert('Thank you for your feedback!')
          }
          else {
            alert('Invalid file extension.')
            success = false
          }  
        }
        else { // The user did not upload the optional TGA file
          alert('Thank you for your feedback!')
        }

        var data = new FormData($('#thermal_stability_neighbor_feedback')[0])
        document.getElementById('thermal_stability_neighbor_feedback').reset() // reset the form
        if (success) { // send form data to backend
          var request = new XMLHttpRequest();
          request.onreadystatechange = function() { return; } // Override the response behavior of the request
          request.open("POST", 'process_feedback', true)
          request.send(data)
        }

        $("#TGA_D").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max)') // resetting input text
      }
    })

    // When the "Submit" button is clicked for the data upload form
    $('#submit_E').click(function () {
      // Returns an alert to the user indicating whether their feedback was accepted. Sends form data to backend if form is filled out well.

      // First, ensures that the required fields are filled out. If not, returns, and no alerts are shown.
      var email = document.getElementById('upload_form_email').value;
      var cif_file = document.getElementById('validatedCustomFile_E1').value;
      var TGA_file = document.getElementById('validatedCustomFile_E2').value;
      var solvent = document.getElementById('data_upload_solvname').value;

      success = true // Tracks whether the form should be sent to the backend

      if (email && cif_file && TGA_file && solvent) { // requisite fields have been filled out

        my_name_1 = cif_file.split(/(\\|\/)/g).pop() // split the string ({filepath}/{filename}) and get the file name
        my_extension_1 = getExtension(my_name_1)
        my_name_2 = TGA_file.split(/(\\|\/)/g).pop() // split the string ({filepath}/{filename}) and get the file name
        my_extension_2 = getExtension(my_name_2);

        if (upload_extensions.includes(my_extension_2.toLowerCase()) && my_extension_1 == "cif") {
          alert('Thank you for your feedback!')
        }
        else {
          alert('Invalid file extension.')
          success = false
        }  

        var data = new FormData($('#upload_form_element')[0])
        document.getElementById('upload_form_element').reset() // reset the form
        if (success) { // send form data to backend
          var request = new XMLHttpRequest();
          request.onreadystatechange = function() { return; } // Override the response behavior of the request
          request.open("POST", 'process_feedback', true)
          request.send(data)
        }

        $("#TGA_E").text('Upload TGA Trace (.pdf, .jpg, .png, .tiff; 20 MB max) *') // resetting input text
        $("#MOF_E").text('Upload MOF (.cif) *')
      }
    })

    // When the "Submit" button is clicked for the data removal form
    $('#submit_F').click(function () {
      // Returns an alert to the user indicating whether their feedback was accepted. Sends form data to backend if form is filled out well.

      // First, ensures that the required fields are filled out. If not, returns, and no alerts are shown.
      var email = document.getElementById('removal_form_email').value;
      var description = document.getElementById('removal_form_comments').value;

      success = true // Tracks whether the form should be sent to the backend

      if (email && description) { // requisite fields have been filled out

        alert('Thank you, your request is being processed.')

        var data = new FormData($('#removal_form_element')[0])
        document.getElementById('removal_form_element').reset() // reset the form
        if (success) { // send form data to backend
          var request = new XMLHttpRequest();
          request.onreadystatechange = function() { return; } // Override the response behavior of the request
          request.open("POST", 'process_removal', true)
          request.send(data)
        }
      }
    })

    // This function returns the name of the selected MOF
    // If extension is true, keep the .cif at the end; else don't
    function get_selected_MOF(extension = true) {
      var name = document.getElementById('upload_status').innerHTML; // getting the name of the selected MOF
      name = name.split(' ');
      name = name.slice(-1)[0]; // getting the last element of the array
      if (!extension) {
        if (name.substring(name.length - 4) == '.cif') { // getting rid of the .cif part
          name = name.substring(0, name.length - 4)
        }
      }

      return name
    }


    // When the "Dark mode" button is clicked:
    black = '#000000'
    white = '#FFFFFF'
    $('#dark_mode').click(function () { // change background and button text depending on button state
      button_text = document.getElementById('dark_mode').textContent
      if (button_text == 'Dark mode') { // make background dark and text white
        $('body').css("background-color", black);
        document.getElementById('dark_mode').textContent = 'Light mode';
        $('.zebra').css('color', white)
        $('#header_background').css('background-image', 'url(\'banner_dark\')')
      }
      else { // Button says Light mode; make background white and text black
        $('body').css("background-color", white);
        document.getElementById('dark_mode').textContent = 'Dark mode';
        $('.zebra').css('color', black)
        $('#header_background').css('background-image', 'url(\'banner_light\')')
      }
    })

    // tab functionality
    // https://getbootstrap.com/docs/5.0/components/navs-tabs/
    // https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll
    const container = document.querySelector('#pills-tab')
    const matches = container.querySelectorAll('li.nav-item > button') // Getting the tab options
    var triggerTabList = [].slice.call(matches) // making the tab options into a list
    triggerTabList.forEach(function (triggerEl) { // going through each of the tab options
      var tabTrigger = new bootstrap.Tab(triggerEl)

      triggerEl.addEventListener('click', function (event) {
        event.preventDefault()
        tabTrigger.show()
      })
    })

    // The code below that has a lot of hide and show operations is the tab functionality that allows the user to switch tabs.
    // For example, when the Visualization tab is clicked, all website displays that don't have to do with visualization are hidden, and visualization functionality is shown

    // Helper function for the code below. Hides the appropriate sections when a button is clicked.
    function section_hider(current_section) {
      // hide everything but current_section
      sections = ['#pills-main', '#pills-vis', '#pills-comp', '#pills-bb', '#pills-example', '#pills-data']
      $(current_section).show()
      for (var i = 0; i < sections.length; i++) {
        if (sections[i] != current_section) {
          $(sections[i]).hide()
        }
      }
    }

    $('#example-redirect').click(function () {
      section_hider('#pills-example')
      $('#MOF_option').val('HKUST-1 (default)') // setting the default value
    })

    $('#bb-redirect').click(function () {
      section_hider('#pills-bb')
    })

    $('#pills-main-tab').click(function () { // Main tab
      section_hider('#pills-main')
    })

    $('#pills-vis-tab').click(function () { // Visualization tab
      section_hider('#pills-vis')
    })

    $('#pills-comp-tab').click(function () { // Component Analysis tab
      section_hider('#pills-comp')
    })

    $('#pills-data-tab').click(function () { // Data Upload tab
      section_hider('#pills-data')
    })


    // Below: populate the linkers, sbus, and net dropdowns in the building block section.
    // I run a script (tobacco_3.0/scrap_cifs.py) in the tobacco_3.0/edges_database folder, the tobacco_3.0/nodes_database folder, and the tobacco_3.0/template_database folder to get a nice array form of all of the available files. I then paste the array into the appropriate places below (for example, my_linkers = ARRAYOFOPTIONS)


    // option_generator is a helper function for populating dropdowns on the website
    var option_generator = function(my_list) {
      var options = ''
      for (var i = 0; i < my_list.length; i++) {
        options += '<option value="' + my_list[i] + '" />';
      }
      return options
    }

    $.get("/list_getter").done(
      function (response) {
        // Purpose of this is to get lists for the code below
        my_linkers = response['my_linkers']
        my_sbus = response['my_sbus']
        my_nets = response['my_nets']
        my_MOFs = response['my_MOFs']

        // Populating the linkers in the building block section
        document.getElementById('linkers_list').innerHTML = option_generator(my_linkers); // populating the linkers dropdown

        // Next, populating the nodes in the building block section.
        document.getElementById('sbus_list').innerHTML = option_generator(my_sbus); // populating the sbus dropdown

        // Populating the nets in the building block section
        document.getElementById('nets_list').innerHTML = option_generator(my_nets); // populating the nets dropdown

        // In addition, populating the CSD MOF options for the Example MOF loading
        document.getElementById('MOFs_list').innerHTML = option_generator(my_MOFs); // populating the MOFs dropdown
      })

    // On startup, hide certain sections
    $('#pills-comp').hide()
    $('#pills-example').hide()
    $('#pills-bb').hide()
    $('#pills-data').hide()
    $('#predict_section').hide()
    $('#descriptor_section').hide()
    $('#neighbor_blurb').hide()
    $('#thermal_neighbor_section').hide()
    $('#solvent_neighbor_section').hide()
    $('#status_section').hide()
    $('#cif_hint').hide()

    function viewer_hider() {
      $('#pills-vis').hide()
    }

    // This is my hacky way to get around the fact that the full MOF viewport does not work if it is immediately hidden.
    // I just wait a bit, then hide it
    window.setTimeout(viewer_hider, 5)

    // functions to handle the selection and prediction and visualize and component button color change upon mouse hover
    // since we change the selection and prediction and visualize and component button colors and lose the default hover color change
    $("#example-redirect").hover(function () {
      $(this).css("background-color", "#1D2B37"); // #1D2B37 is the dark blue that is the default hover color for the buttons 
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", load_color);
      $(this).css("border-color", load_color);
    });

    $("#upload").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", upload_color);
      $(this).css("border-color", upload_color);
    });

    $("#bb-redirect").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", bb_redirect_color);
      $(this).css("border-color", bb_redirect_color);
    });

    $("#predict_s").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", solvent_pred_color);
      $(this).css("border-color", solvent_pred_color);
    });

    $("#predict_t").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", thermal_pred_color);
      $(this).css("border-color", thermal_pred_color);
    });

    $("#visualize").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", visualize_color);
      $(this).css("border-color", visualize_color);
    });

    $("#get_components").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", component_color);
      $(this).css("border-color", component_color);
    });

    $("#download_descriptors").hover(function () {
      $(this).css("background-color", "#1D2B37");
      $(this).css("border-color", "#1D2B37");
    }, function () {
      $(this).css("background-color", descriptor_color);
      $(this).css("border-color", descriptor_color);
    });

    $(".link").hover(function () { // for hyperlinks
      $(this).css("color", '#18bc9c');
    }, function () {
      $(this).css("color", '#279AF1');
    });

    // When the "Yes" button is clicked for storage permission line
    $("#perm_yes").click(function () {
      $('#permission_line').hide()
      $.post("/permission", JSON.stringify(true)).done(function (response) {
      })
    })

    // When the "No" button is clicked for storage permission line
    $("#perm_no").click(function () {
      $('#permission_line').hide()
      $.post("/permission", JSON.stringify(false)).done(function (response) {
      })
    })

  });


</script>
<!-- End of Javascript section -->

<!-- sbu.js is pulled from https://github.com/snurr-group/web-mofid, for visualization purposes. Not all of the code in it is used by our website. -->
<script async type="text/javascript" src="libraries/sbu.js"></script>
